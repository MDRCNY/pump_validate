---
title: "Validate Power: blocked_i1"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
output:
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---
# Purpose

This document lays out results for estimating statistical power and minimum detectable effect size (MDES) for:
Blocked RCT, with 2 levels, and randomization done at level 1 (individual level). This document contains models assuming constant treatment effects, fixed treatment effects, and random treatment effects.

We compare results of the derived methods against Monte Carlo Simulations & the PowerUp R package on power. The methods are derived by Kristin Porter as outlined in the paper/s here (Add reference section).

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))
params.default <- user.params.list

# validate MDES and sample size?
validate.mdes.ss = FALSE
```


# Power Validation

In this section, we validate power results for different definitions of power and different adjustment procedures.

If you are previewing this in html, please click on the code section to review more detailed parameters.

This section sets up the simulation-level parameters, such as how many monte carlo samples to draw.

```{r sim.params}
# print(sim.params.list)
```

```{r user.params}
# print(user.params.list)
```

### Setup 1: School size 100

Main parameters:

* n.j = 100
* M = 3
* J = 20
* rho = (0.5, 0.5, 0.5)
* MDES = (0.125, 0.125, 0.125)
* R2.1 = (0, 0, 0)
* R2.2 = (0, 0, 0)
* ICC.2 = (0, 0, 0)
* Omega.2 = 0.5

`r colorize("Individual Statistical power is estimated to be around 0.8. Please check the table below for estimations of other definitions of statistical power. Across all power definitions, estimation results across the __PUMP__ package, __Monte Carlo Simulation__ results and __PowerUp__ package are about the same as detailed below.", "green")`

```{r 2c.rho0.5tPMnj100}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_i1_2c_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_i1_2c_nj100_power_plot)
```


```{r 2f.rho0.5tPMnj100}
design <- "blocked_i1_2f"
user.params.list[['omega.2']] <- 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_i1_2f_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_i1_2f_nj100_power_plot)
```

```{r 2r.rho0.5tPMnj100}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] <- 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_i1_2r_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_i1_2r_nj100_power_plot)
```

### Setup 2: School size 75

* n.j = 75

```{r rho0.5tPMnj75}
user.params.list[['n.j']] <- 75
```

```{r 2c.rho0.5tPMnj75}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
blocked_i1_2c_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_nj75_power_plot)
```


```{r 2f.rho0.5tPMnj75}
design <- "blocked_i1_2f"
user.params.list[['omega.2']] <- 0.5
blocked_i1_2c_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_nj75_power_plot)
```

```{r 2r.rho0.5tPMnj75}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] <- 0.5
blocked_i1_2r_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2r_nj75_power_plot)
```

### Setup 3: School size 50

* n.j = 50

```{r rho0.5tPMnj50}
user.params.list[['n.j']] <- 50
```


```{r 2c.rho0.5tPMnj50}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
blocked_i1_2c_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_nj50_power_plot)
```

```{r 2f.rho0.5tPMnj50}
design <- "blocked_i1_2f"
user.params.list[['omega.2']] <- 0.5
blocked_i1_2f_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2f_nj50_power_plot)
```

```{r 2r.rho0.5tPMnj50}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] <- 0.5
blocked_i1_2r_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2r_nj50_power_plot)
```


# Varying R2

R2.1 = 0.6, 0.6, 0.6

```{r r2.10.6nj50}
user.params.list[['R2.1']] <- rep(0.6, M)  
```

```{r 2c.r2.10.6nj50}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
blocked_i1_2c_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_r2.1_power_plot)
user.params.list[['R2.1']] <- params.default[['R2.1']]  
```


R2.2 = 0.6, 0.6, 0.6

```{r r2.20.6nj50}
user.params.list[['R2.2']] <- rep(0.6, M)  
```

```{r 2c.r2.20.6nj50}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
blocked_i1_2c_r2.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_r2.2_power_plot)
user.params.list[['R2.2']] <- params.default[['R2.2']]  
```


# Varying rho

rho.default = 0.2

```{r rho0.2tPMnj50}
rho.default <- 0.2
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <- rho.default
```

```{r 2c.rho0.2tPMnj50}
design <- "blocked_i1_2c"
blocked_i1_2c_rho0.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_rho0.2_power_plot)
```

rho.default = 0.8

```{r rho0.8tPMnj50}
rho.default <- 0.8
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```

```{r 2c.rho0.8tPMnj50}
design <- "blocked_i1_2c"
blocked_i1_2c_rho0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_rho0.8_power_plot)
# reset
rho.default <- params.default[['rho.default']]
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```


# Varying true positives

MDES = 0.125, 0, 0

```{r MDES0.12500nj50}
user.params.list[['ATE_ES']] <- c(0.125, 0, 0)
```


```{r 2c.MDES0.12500nj50}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
blocked_i1_2c_mdes0.1250.00.0.00_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2c_mdes0.1250.00.0.00_power_plot)
user.params.list[['ATE_ES']] <- params.default[['ATE_ES']]
```

# Varying ICC for relevant models

ICC.2 = c(0.8, 0.8, 0.8)

```{r ICC20.5nj50}
user.params.list[['ICC.2']] <- rep(0.8, M)
```

```{r 2r.ICC20.5nj50}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] <- 0.5
blocked_i1_2r_ICC2.0.5_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_2r_ICC2.0.5_power_plot)
user.params.list[['ICC.2']] <- params.default[['ICC.2']]
```

# MDES validation

In this section, we validate the derived minimum detectable effect size (MDES) function across different __MTP__ (Bonferroni, Benjamini-Hocheberg and Holms) and __power definition__ (individual and minimum_1).  The validation is carried out by generating power values for the specific __MTP__ and __power__ definitions for a specific __MDES__. Then, we supply the generated estimate __power__ as an input parameter to see if the specified __MDES__ is returned.

## Power: 0.65 - 0.87

Below, we have input parameters of number of outcomes, minimum detectable effect size, statistical power, and significance level that would estimate a high statistical power value of above __0.65__ to __1.00__ for different definitions of power. This estimated power value is used as an input to the mdes function where we validate if the _returned_ __mdes__ value is close to the __mdes__ value that was inputted to provide the estimated power.

### Individual Power

School size: 50

```{r}
# reset to defaults
rho.default <- 0.5
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <- default.rho.matrix
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <- default.rho.matrix
user.params.list[['ATE_ES']] = c(0.125, 0.125, 0.125)
user.params.list[['R2.1']] <- rep(0, M)  
user.params.list[['R2.2']] <- rep(0, M)
```

`r colorize("The Bonferroni, Benjamini Hocheberg and Holms' __adjusted MDES__ and the __targeted MDES__ are within an acceptable margin of error for the specified targetted power. The __adjusted MDES__ is estimated at the __corresponding__ individual power in the table below. The __corresponding__ individual power is the power at which our MDES method stops looking for a MDES value close to the target MDES.", "green")`

```{r 2c.mdesCombined}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] = 0
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2c_mdes_results_nj50 <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_i1_2c_mdes_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 2f.mdesCombined}
design <- "blocked_i1_2f"
user.params.list[['omega.2']] = 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2f_mdes_results_nj50 <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_i1_2f_mdes_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )    
}
```

```{r 2r.mdesCombined}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] = 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2r_mdes_results_nj50 <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_i1_2r_mdes_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

# Sample size validation

School size: 50

```{r 2c.sampleCombined}
design <- "blocked_i1_2c"
user.params.list[['omega.2']] = 0
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2c_sample_results_nj50 <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_i1_2c_sample_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r 2f.sampleCombined}
design <- "blocked_i1_2f"
user.params.list[['omega.2']] = 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2f_sample_results_nj50 <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_i1_2f_sample_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r 2r.sampleCombined}
design <- "blocked_i1_2r"
user.params.list[['omega.2']] = 0.5
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_i1_2r_sample_results_nj50 <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_i1_2r_sample_results_nj50,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```