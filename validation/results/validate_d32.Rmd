---
title: "Validate Power: d3.2"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: pdf_document
---

Design: Blocked Cluster RCT, with 3 levels, and randomization done at level 2 (school level).

Models: random and fixed treatment effects.

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(
  cache = TRUE, warning = FALSE, message = FALSE, echo = FALSE,
  fig.height = 4
)
```

```{r setup}
library(here)
library(PUMP)
library(pander)
# default tables to round to 3 digits
panderOptions('round', 3)
source(here::here("validation/code", "misc.R"))
```

```{r sim.params}
sim.params.list <- list(
  S = 5000                     # Number of samples for Monte Carlo Simulation
  , Q = 1
)
```

```{r}
M <- 3
model.params.list <- list(
  M = 3                                   # number of outcomes
  , J = 30                                # number of schools
  , K = 10                                # number of districts (for two-level model, set K = 1)
  , nbar = 50                             # number of individuals per school
  , rho.default = 0.5                     # default rho value
  ################################################## grand mean outcome and impact
  , MDES = rep(0.125, M)                  # minimum detectable effect size      
  ################################################## level 3: districts
  , ICC.3 = rep(0.2, M)                   # district intraclass correlation
  , omega.3 = rep(0.1, M)                 # ratio of district effect size variability to random effects 
  ################################################## level 2: schools
  , numCovar.2 = 1                        # number of school covariates
  , R2.2 = rep(0.1, M)                    # percent of school variation explained by school covariates
  , ICC.2 = rep(0.2, M)                   # school intraclass correlation	
  ################################################## level 1: individuals
  , numCovar.1 = 1                        # number of individual covariates
  , R2.1 = rep(0.1, M)                    # percent of indiv variation explained by indiv covariates
)
params.default <- model.params.list
```

Default parameters:

* M = `r model.params.list[['M']]`
* J = `r model.params.list[['J']]`
* K = `r model.params.list[['K']]`
* rho: $\rho$ =  `r model.params.list[['rho.default']]`
* MDES: `r model.params.list[['MDES']]`
* R2: $R^2_1$ = `r model.params.list[['R2.1']]`, $R^2_2$ = `r model.params.list[['R2.2']]`, $R^2_3 = 0$
* ICC: $\text{ICC}_2$ = `r model.params.list[['ICC.2']]`, $\text{ICC}_3$ = `r model.params.list[['ICC.3']]`
* Omega2: $\omega_2$ = 0

Parameters by model type:

* Omega3: $\omega_3$ = 0 for fixed effects, $\text{omega}_3$ = `r model.params.list[['omega.3']]` for random effects

# Power Validation

## Base case

```{r 3f_nbar50}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_nbar50_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_nbar50_power_plot)
```

```{r 3r_nbar50}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_nbar50_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_nbar50_power_plot)
```

## Varying school size

```{r nbar100}
model.params.list[['nbar']] <- 100
```

$\bar{n}$ = `r model.params.list[['nbar']]`

```{r 3f_nbar100}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
d3.2_m3ff2rc_nbar100_power_plot <- gen.power.results.plot(params.file.base, design)
print(d3.2_m3ff2rc_nbar100_power_plot)
```

```{r 3r_nbar100}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
d3.2_m3rr2rc_nbar100_power_plot <- gen.power.results.plot(params.file.base, design)
print(d3.2_m3rr2rc_nbar100_power_plot)
```

```{r nbar75}
model.params.list[['nbar']] <- 75
```

$\bar{n}$ = `r model.params.list[['nbar']]`

```{r 3f_nbar75}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_nbar75_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_nbar75_power_plot)
```

```{r 3r_nbar75}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_nbar75_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_nbar75_power_plot)
```

```{r nbar50}
model.params.list[['nbar']] <- 50
```

## Varying R2

```{r r2106}
model.params.list[['R2.1']] <- rep(0.6, M)  
```

$R^2_1 =$ `r model.params.list[['R2.1']]`

```{r 3f_r2106}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_r2.1_power_plot)
```

```{r 3r_r2106}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_r2.1_power_plot)
```

```{r r21reset}
model.params.list[['R2.1']] <- params.default[['R2.1']]  
```

```{r r2206}
model.params.list[['R2.2']] <- rep(0.6, M)  
```

$R^2_2 =$ `r model.params.list[['R2.2']]`

```{r 3f_r2206}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_r2.2_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_r2.2_power_plot)
```

```{r 3r_r2206}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_r2.1_power_plot)
```

```{r r22reset}
model.params.list[['R2.2']] <- params.default[['R2.2']]  
```


```{r r210r220r230}
model.params.list[['R2.1']] <- rep(0, M)  
model.params.list[['R2.2']] <- rep(0, M)  
```

$R^2_1 =$ `r model.params.list[['R2.1']]`
$R^2_2 =$ `r model.params.list[['R2.2']]`

```{r 3f_r210r220r230}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_r2.3_power_plot)
```

```{r 3r_r210r220r230}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_r2.3_power_plot)
```

```{r r2reset}
model.params.list[['R2.1']] <- params.default[['R2.1']] 
model.params.list[['R2.2']] <- params.default[['R2.2']] 
```

## Varying rho

```{r rho02}
rho.default <- 0.2
model.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
model.params.list[['rho.default']] <- rho.default
model.params.list[['rho.V']] <- model.params.list[['rho.X']] <- model.params.list[['rho.C']] <- default.rho.matrix
model.params.list[['rho.u0']] <- model.params.list[['rho.u1']] <- default.rho.matrix
model.params.list[['rho.w0']] <- model.params.list[['rho.w1']] <- default.rho.matrix
model.params.list[['rho.r']] <- default.rho.matrix
```

$\rho =$ `r model.params.list[['rho.default']]`

```{r 3f_rho02}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_rho0.2_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_rho0.2_power_plot)
```

```{r rho08}
rho.default <- 0.8
model.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
model.params.list[['rho.V']] <- model.params.list[['rho.X']] <- model.params.list[['rho.C']] <- default.rho.matrix
model.params.list[['rho.u0']] <- model.params.list[['rho.u1']] <- default.rho.matrix
model.params.list[['rho.w0']] <- model.params.list[['rho.w1']] <- default.rho.matrix
model.params.list[['rho.r']] <- default.rho.matrix
```

$\rho =$ `r model.params.list[['rho.default']]`

```{r 3f_rho08}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_rho0.8_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_rho0.8_power_plot)
```

```{r rhoreset}
# reset
rho.default <- params.default[['rho.default']]
model.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
model.params.list[['rho.V']] <- model.params.list[['rho.X']] <- model.params.list[['rho.C']] <- default.rho.matrix
model.params.list[['rho.u0']] <- model.params.list[['rho.u1']] <- default.rho.matrix
model.params.list[['rho.w0']] <- model.params.list[['rho.w1']] <- default.rho.matrix
model.params.list[['rho.r']] <- default.rho.matrix
```


## Varying true positives

```{r MDES012500}
model.params.list[['MDES']] <- c(0.125, 0, 0)
```

MDES = `r model.params.list[['MDES']]`

```{r 3f_MDES012500}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_mdes0.1250.00.0.00_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_mdes0.1250.00.0.00_power_plot)
```

```{r MDESreset}
model.params.list[['MDES']] <- params.default[['MDES']]
```

## Varying ICC

```{r ICC207}
model.params.list[['ICC.2']] <- rep(0.7, M)
```

$\text{ICC}_2$ = `r model.params.list[['ICC.2']]`

```{r 3f_ICC207}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_ICC2.0.7_power_plot)
```

```{r 3r_ICC207}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_ICC2.0.7_power_plot)
```

```{r ICC207reset}
model.params.list[['ICC.2']] <- params.default[['ICC.2']]
```

```{r ICC307}
model.params.list[['ICC.3']] <- rep(0.7, M)
```

$\text{ICC}_3$ = `r model.params.list[['ICC.3']]`

```{r 3r_ICC307}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_ICC3.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_ICC3.0.7_power_plot)
```

```{r ICC307reset}
model.params.list[['ICC.3']] <- params.default[['ICC.3']]
```

```{r ICC20}
model.params.list[['ICC.2']] <- rep(0, M)
```

$\text{ICC}_2$ = `r model.params.list[['ICC.2']]`

```{r 3f_ICC20}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_ICC2.0_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_ICC2.0_power_plot)
```

```{r 3r_ICC20}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_ICC2.0_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_ICC2.0_power_plot)
```

```{r ICC20reset}
model.params.list[['ICC.2']] <- params.default[['ICC.2']]
```

```{r ICC30}
model.params.list[['ICC.3']] <- rep(0, M)
```

$\text{ICC}_2$ = `r model.params.list[['ICC.2']]`

```{r 3f_ICC30}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_ICC2.0_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_ICC2.0_power_plot)
```

```{r 3r_ICC30}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_ICC2.0_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_ICC2.0_power_plot)
```

```{r ICC30reset}
model.params.list[['ICC.3']] <- params.default[['ICC.3']]
```


## Varying Omega

```{r omega308}
model.params.list[['omega.3']] <- rep(0.8, M)
model.params.list[['K']] <- 20
```

$\omega_3$ = `r model.params.list[['omega.3']]`

```{r 3r_omega308}
design <- "d3.2_m3rr2rc"
blocked_i1_3r_omega3.0.8_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0.8_power_plot)
```

```{r omega308reset}
model.params.list[['omega.3']] <- params.default[['omega.3']]
model.params.list[['K']] <- params.default[['K']]
```


```{r omega30}
model.params.list[['omega.3']] <- rep(0, M)
```

$\omega_3$ = `r model.params.list[['omega.3']]`
$\text{ICC}_3$ = `r model.params.list[['ICC.3']]`

```{r 3r_omega30ICC307}
design <- "d3.2_m3rr2rc"
blocked_i1_3r_omega3.0ICC30.7_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0ICC30.7_power_plot)
```

```{r omega30reset}
model.params.list[['omega.3']] <- params.default[['omega.3']]
```

```{r omega308ICC307}
model.params.list[['omega.3']] <- rep(0.8, M)
model.params.list[['ICC.3']] <- rep(0.7, M)
model.params.list[['K']] <- 20
```

$\omega_3$ = `r model.params.list[['omega.3']]`
$\text{ICC}_3$ = `r model.params.list[['ICC.3']]`


```{r 3r_omega308ICC307}
design <- "d3.2_m3rr2rc"
blocked_i1_3r_omega3.0.8ICC30.7_power_plot <- gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0.8ICC30.7_power_plot)
```

```{r omega3.ICC3.reset}
model.params.list[['omega.3']] <- params.default[['omega.3']]
model.params.list[['ICC.3']] <- params.default[['ICC.3']]
model.params.list[['K']] <- params.default[['K']]
```


## Kappa

```{r kappa04}
kappa <- 0.4
kappa.matrix <- diag(kappa, M)
model.params.list[['kappa.w']] <- model.params.list[['kappa.u']] <- kappa.matrix
```

$\kappa$ = `r kappa`

```{r 3f_kappa04}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
d3.2_m3ff2rc_kappa0.4_power_plot <-
  gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_kappa0.4_power_plot)
```

```{r 3r_kappa04}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
d3.2_m3rr2rc_kappa0.4_power_plot <-
  gen.power.results.plot(gen_params_file_base(model.params.list, sim.params.list, design), design)
print(d3.2_m3rr2rc_kappa0.4_power_plot)
```

```{r kappa04reset}
model.params.list[['kappa.w']] <- model.params.list[['kappa.u']] <- params.default[['kappa.w']]
```

# MDES validation

```{r}
# reset to defaults
model.params.list <- params.default 
```


```{r 3f_mdes_D1}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes_D1indiv')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3ff2rc_mdes_D1_results <- readRDS(mdes.file)
  pander::pandoc.table(
    d3.2_m3ff2rc_mdes_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3r_mdes_D1}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes_D1indiv')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3rr2rc_mdes_D1_results <- readRDS(mdes.file)
  pander::pandoc.table(
    d3.2_m3rr2rc_mdes_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```


# Sample size validation

```{r 3f_sampleD1_J}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3ff2rc_sample_D1_J_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3ff2rc_sample_D1_J_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r 3f_sampleD1_K}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3ff2rc_sample_D1_K_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3ff2rc_sample_D1_K_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r 3f_sampleD1_nbar}
design <- "d3.2_m3ff2rc"
model.params.list[['omega.3']] <- NULL
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3ff2rc_sample_D1_nbar_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3ff2rc_sample_D1_nbar_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```



```{r 3r_sampleD1_J}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3rr2rc_sample_D1_J_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3rr2rc_sample_D1_J_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r 3r_sampleD1_K}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3rr2rc_sample_D1_K_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3rr2rc_sample_D1_K_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r 3r_sampleD1_nbar}
design <- "d3.2_m3rr2rc"
model.params.list[['omega.3']] <- params.default[['omega.3']]
params.file.base <- gen_params_file_base(model.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.2_m3rr2rc_sample_D1_nbar_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.2_m3rr2rc_sample_D1_nbar_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```