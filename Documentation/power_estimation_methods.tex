\documentclass[12pt]{article}
\usepackage[margin=0.75in]{geometry}

\usepackage{xcolor}
\usepackage{amsmath, amssymb}
\usepackage{bm}
\usepackage{dsfont}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{parskip}
\usepackage{verbatim}

\newcommand\mb[1]{\boldsymbol{#1}}

\usepackage{natbib}
\bibliographystyle{abbrvnat}
% \setcitestyle{authoryear, open={((},close={)}}

% paragraph formatting
%\setlength{\parindent}{0pt}
%\setlength{\parskip}{12pt plus 4mm minus 3mm}

\setcounter{tocdepth}{2}

\begin{document}

\author{Porter, Miratrix, Hunter}
\title{Power estimation methods}

\maketitle

\tableofcontents 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Model taxonomy
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Experiment and Model taxonomy}

Our package allows for power calculations across a range of common scenarios or \emph{Designs}.
To identify a given design, we distinguish between the planned experimental design (e.g., clustered data, with randomization within cluster) and the model used for the planned analysis (e.g., multilevel modeling of some sort).
Each of these components need to be identified and specified.

We first identify designs by noting the number of levels of nesting (e.g., students in schools in districts would be three levels) and the level of randomization (e.g., randomization at schools would be randomization at level 2).

The models are a bit more complex. For the models used for analysis, we create a taxonomy by noting what modeling choice is used at each level of the model, and how covariates are used.
In particular we have:
\begin{itemize}
\item Whether the school-level and district-level intercepts are:
\begin{itemize}
\item fixed ($u_{0,jkm}$ and $w_{0,jkm}$ are fixed effects constrained to have mean 0)
\item random ($u_{0,jkm}$ and $w_{0,jkm}$ are considered to be Normally distributed, allowing for partial pooling)
\end{itemize}
\item Whether the school-level and district-level treatment effects are:
\begin{itemize}
\item constant, e.g. all schools and districts are modeled as having a single average impact ($u_{1,jkm}= 0$ and $w_{1,km} = 0$)
\item fixed, e.g. each school or district has an individual estimated impact ($u_{1,jkm}$ are fixed values constrained to have mean 0), with an additional mean impact.
\item random ($u_{1,jkm}$ and $w_{1,km}$ are Normally distributed around a mean impact)
\end{itemize}
\end{itemize}

In addition, the user has choices for whether to include certain covariates in the intercept models.
We allow for covariates to be included wherever it makes sense for the model.
Note that in some models, PowerUp incorporates covariates into the slope, allowing for, in principle, heterogeneous treatment effects correlated to said covariates.
However, we never make this assumption, as it is unlikely to help with an evaluating targeting an overall average impact.
Including covariates in the slope terms allows for modeling treatment effect heterogeneity in principle, but this can add complexity with estimation. When this difference occurs, it is noted.



\subsection{Overall Design naming convention}

The general naming convention follows:
d[parameters]\_m[parameters]

For design parameters, the first number is the number of levels, and the second is the level at which treatment is assigned.

For model parameters, each set corresponds to the level, how the intercepts are modeled, and how the effects are modeled.

Examples:
\begin{itemize}
\item d2.1\_m2rr: 2 level, individual assignment, level 2 random intercept and random treatment effect.  Corresponds to current blocked\_i1\_2r.
\item d3.2\_m3ff2rc: 3 level, level 2 assignment, level 3 fixed intercepts and fixed treatment effects, level 2 random intercepts and constant treatment effects. Corresponds to current blocked\_c2\_3f.
\end{itemize}

\begin{table}[h!]
\begin{tabular}{l | l}
% \begin{tabular}{p{5cm} | p{5cm}}
\textbf{PowerUpR!}	& \textbf{PUMP} \\ \hline
blocked\_i1\_2c 	& d2.1\_m2fc \\
blocked\_i1\_2f 	& d2.1\_m2ff \\
blocked\_i1\_2r 	& d2.1\_m2fr \\
blocked\_i1\_3r 	& d3.1\_m3rr2rr \\
simple\_c2\_2r 		& d2.2\_m2rc \\
simple\_c3\_3r 		& d3.3\_m3rc2rc \\
blocked\_c2\_3f 	& d3.2\_m3ff2rc \\
blocked\_c2\_3r 	& d3.2\_m3rr2rc \\
\end{tabular}
\caption{Correspondence between design names\label{tab:names}}
\end{table}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Notation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Notation}
\label{sec:notation}

For all notation, we use $i$ to index individuals, $j$ to index schools, $k$ to index districts, and $m$ to index outcomes.
Tables~\ref{tab:observed_param}-\ref{tab:derived_param} outline all important quantities for calculating power, MDES, and sample size.
Table~\ref{tab:powerup} provides a reference for translating notation between this document and PowerUpR!
We now provide further clarification on the parameters in Table~\ref{tab:derived_param}; for a more detailed discussion of these expressions, see Section~\ref{sec:tune}.

The quantity $\text{ICC}$ is the Intraclass Correlation for the unconditional model. The following expressions include the variation, therefore, due to covariates.  All covariates are assumed to be group-mean centered and have unit variance.  (This creates the pairing of terms in the equations below.)

\begin{align*}
\text{ICC}_{3,m} &= \frac{Var(\mu_{0,km})}{ Var(Y_{ijkm}(0))} = \frac{\xi^2_m + \eta_{0,m}^2}{\left(\xi_m^2 +  \eta^2_{0,m}\right) + \left(\delta_m^2  + \tau^2_{0,m}\right) + \left(\gamma_m^2 + \sigma^2_m\right)}\\
\text{ICC}_{2,m} &= \frac{Var(\theta_{0,jkm} \mid \mu_{0,km})}{ Var(Y_{ijkm}(0))} = \frac{\delta_m^2  + \tau_{0,m}^2}{ \left(\xi_m^2 +  \eta^2_{0,m}\right) + \left(\delta_m^2  + \tau^2_{0,m}\right) + \left(\gamma_m^2 + \sigma^2_m\right)}
\end{align*}

The quantity $\omega$ is the ratio between impact variation and mean variation.

\begin{align*}
\omega_{3,m} &=  \frac{Var(\mu_{1,jkm})}{Var(\mu_{0,km})} = \frac{\eta^2_{1,m}}{\xi^2_m + \eta_{0,m}^2}\\
\omega_{2,m} &=  \frac{Var(\psi_{1,jkm} \mid \mu_{1,km})}{Var(\theta_{0,jkm} \mid \mu_{0,km})} = \frac{\tau^2_{1,m}}{\delta_m^2 + \tau^2_{0,m}}
\end{align*}

The $R^2$ expressions are the percent of variation at a particular level predicted by covariates specific to that level.

\begin{align*}
R_{3,m}^2 &= 1 - \frac{Var(w_{0,km})}{Var(\mu_{0,km})} = 1 - \frac{\eta^2_{0,m}}{\xi_m^2 + \eta^2_{0,m}} \\
R_{2,m}^2 &= 1 - \frac{Var(u_{0,jkm})}{Var(\theta_{0,jkm} \mid D_{id})} = 1 - \frac{\tau^2_{0,m}}{\delta_m^2 + \tau^2_{0,m}}\\
R^2_{1,m} &= 1 - \frac{Var(r_{ijkm})}{Var( Y_{ijkm}(0) \mid S_{id}, D_{id})} = 1 - \frac{ \sigma^2_m }{ \gamma_m^2 + \sigma^2_m }
\end{align*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Notation tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{table}[p]
\begin{tabular}{p{1.5cm} | p{16cm}}
Param											& Description \\ \hline
$M$												& Number of outcomes \\
$J$												& Number of schools in each district (assumed constant across districts) \\
$K$												& Number of districts \\
$\bar{n}$										& Number of individuals within each school (assumed constant across schools) \\
$\bar{T}$										& Proportion of the sample that is assigned to the treatment group (assumed constant) \\
$N$												& Total number of units $N =\sum_{k=1}^{K} \sum_{j=1}^{J}  \bar{n}$ \\ \hline
$S_{id}$										& Categorical variable indicating the membership of individual $i$ to a school\\
$D_{id}$										& Categorical variable indicating the membership of individual $i$ to a district\\ \hline
$Y_{ijmk}(0)$									& Potential outcome for unit $i$ in school $j$ in district $k$ for outcome $m$ given no treatment\\
$Y_{ijmk}(1)$									& Potential outcome for unit $i$ in school $j$ in district $k$ for outcome $m$ given treatment\\ \hline
$V_{km}$										& District covariates \\
$g_{1,m}$										& Number of district covariates for outcome $m$\\
$X_{jkm}$										& School covariates \\
$g_{2,m}$										& Number of school covariates for outcome $m$\\
$C_{ijkm}$										& Individual covariates \\
$g_{1,m}$										& Number of individual covariates for outcome $m$\\
\end{tabular}
\caption{Observed quantities\label{tab:observed_param}}
\end{table}


\begin{table}[p]
\begin{tabular}{p{1.5cm} | p{16cm}}
Param											& Description \\ \hline
$\psi_{1,jkm}$									& Mean impact for school $j$ in district $k$ for outcome $m$\\ \hline
$\xi_m$											& Coefficient of district covariates $V_{km}$ \\
$\delta_{m}$									& Coefficient of school covariates $X_{jkm}$ \\
$\gamma_{m}$									& Coefficient of individual covariates $C_{ijkm}$ \\
\end{tabular}
\caption{Parameters we estimate\label{tab:estimate_param}}
\end{table}


\begin{table}[p]
\begin{tabular}{p{1.5cm} | p{16cm}}
Param											& Description \\ \hline
$\Xi_{0,m}$ 									& Grand mean outcome under no treatment across districts for outcome $m$\\
$\Xi_{1,m}$										& Grand mean impact across districts for outcome $m$\\
$\mu_{0,km}$									& Grand mean outcome under no treatment across schools in district $k$ for outcome $m$\\
$\mu_{1,km}$									& Grand mean impact across schools in district $k$ for outcome $m$\\
$\theta_{0,jkm}$								& Mean outcome under no treatment for school $j$ in district $k$ for outcome $m$\\
$\psi_{1,jkm}$									& Mean impact for school $j$ in district $k$ for outcome $m$\\ \hline
$w_{0,km}$										& District intercepts\\
$w_{1,km}$										& District impacts \\
$\eta^2_{0,m}$									& Variance of district random effects for outcome $m$ \\
$\eta^2_{1,m}$									& Variance of district impacts for outcome $m$ (cross-district treatment heterogeneity) \\ \hline
$u_{0,jkm}$										& School intercepts\\
$u_{1,jkm}$										& School impacts \\
$\tau^2_{0,m}$									& Variance of school random effects for outcome $m$ \\
$\tau^2_{1,m}$									& Variance of school impacts for outcome $m$ (cross-school treatment heterogeneity) \\ \hline
$r_{ijkm}$										& Individual intercepts \\
$\sigma^2_{m}$									& Variance of individual/level 1 residuals \\
\end{tabular}
\caption{Latent parameters\label{tab:latent_param}}
\end{table}


\begin{table}[p]
\begin{tabular}{l | l}
Param				& Description																				\\ \hline
$ES_{m}$				& effect size																				\\
$\text{ICC}_{3,m}$			& level 3 (district) intraclass correlation													\\
$\omega_{3,m}$		& ratio of variation of district impacts to district residuals								\\
$\text{ICC}_{2,m}$			& level 2 (school) intraclass correlation													\\
$\omega_{2,m}$		& ratio of variation of school impacts to school residuals									\\
$R_{3,m}^2$			& percent of district variation explained by level 3 (district) covariate	$V_{km}$			\\
$R_{2,m}^2$			& percent of school variation explained by level 2 (school) covariate	$X_{jkm}$			\\
$R_{1,m}^2$			& percent of individual variation explained by level 1 (individual covariate) $C_{ijkm}$		\\
\end{tabular}
\caption{Derived parameters\label{tab:derived_param}}
\end{table}

\begin{table}[p]
\begin{tabular}{l | l | l}
PowerUp				& PUMP							& Description \\ \hline
$\beta_{0j}$		& $\theta_{0,jkm}$				& Mean outcome under no treatment for school $j$ in district $k$\\
$\beta_{1j}$		& $\psi_{1,jkm}$					& Mean impact for school $j$ in district $k$ \\ \hline
$X_{ij}$			& $C_{ijkm}$					& Individual covariates \\ 
$\beta_{2j}$		& $\gamma_{m}$					& Coefficient of individual covariates $C_{ijkm}$ \\ \hline
$\gamma_{00}$		& $\mu_{0,km}$					& Grand mean outcome under no treatment across schools in district $k$ \\
$\gamma_{10}$		& $\mu_{1,km}$					& Grand mean impact across schools in district $k$\\
$W_{jk}$			& $X_{jkm}$						& School covariates \\
$\gamma_{01k}$		& $\delta_{m}$					& Coefficient of school covariates $X_{jkm}$ \\
$\mu_{0j}$			& $u_{0,jkm}$					& School intercepts\\
$\mu_{1j}$			& $u_{1,jkm}$					& School impacts\\
$\tau^2_{2|W}$		& $\tau^2_{0,m}$					& Variance of school random effects \\
$\tau^2_{2}$		& $\tau^2_{0,m} + \delta_{m}^2$	& Overall variance of schools \\
$\tau^2_{T2|W}$		& $\tau^2_{1,m}$					& Variance of school impacts \\
$\rho_2$			& $\text{ICC}_2$					& Intraclass correlation (unconditional) for level 2 \\
$\omega_2$			& $\omega_2$					& Ratio of variation of impacts to residuals	 for level 2 \\
$\tau_{2T2}$		& $\boldsymbol{\kappa}^{w}$ 		& Correlations between school random effects and impacts \\ \hline
$\xi_{000}$			& $\Xi_{0,m}$ 					& Grand mean outcome under no treatment across districts \\
$\xi_{100}$			& $\Xi_{1,m}$ 					& Grand mean impact across districts\\
$V_{k}$				& $V_{km}$						& District covariates \\
$\xi_{001}$			& $\xi_{m}$						& Coefficient of district covariates $V_{km}$ \\
$\zeta_{00}$		& $w_{0,km}$					& District intercepts\\
$\zeta_{10}$		& $w_{1,km}$					& District impacts\\
$\tau^2_{3|V}$		& $\eta^2_{0,m}$					& Variance of district random effects \\
$\tau^2_{3}$		& $\eta^2_{0,m} + \xi_{m}^2$		& Overall variance of districts\\
$\tau^2_{T3|V}$		& $\eta^2_{1,m}$					& Variance of district impacts\\
$\tau_{3T3}$		& $\boldsymbol{\kappa}^{w}$ 		& Correlations between district random effects and impacts \\
\end{tabular}
\caption{Correspondence with PowerUpR!\label{tab:powerup}}
\end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% General strategy
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\subsection{General strategy}

The same strategy is followed for all designs.
First, we lay out a model for our outcomes, $Y_{ijkm}$.
Next, we calculate the standard error of the treatment effect estimate, $\hat{\psi}_m$.
When expressing the estimated treatment effect as an effect size, the standard error is given by:
\begin{align}\label{eqn:qm}
Q_m \equiv \text{SE}\left(\hat{\text{ES}}_m\right) &= \text{SE}\left(\frac{\hat{\psi}_m}{\mbox{VAR}}\right) = \frac{1}{VAR} \text{SE}\left(\hat{\psi}_m\right),
\end{align}
where $VAR$ is some ``Index Variation'' that we are measuring our impacts against.

When analyzing actual data, we would, to estimate $Q_m$, plug in known values for $\bar{T}$, $J$, and $\bar{n}$.
Any other parameters are replaced by sample estimates.
Then, when testing the $m^{\text{th}}$ null hypothesis, $\text{ES}_m = 0$, the test statistic for a $t$-test is given by
\begin{align}t_m \equiv \frac{\hat{\text{ES}}_m}{\hat{Q}_m}.\end{align}
When the null is true, $t_m$ follows a $t$ distribution with mean $0$ and degrees of freedom $\text{df}_m$, depending on the design.

For power calculations we need to know, giving our assumptions on the design, a reasonable value for $Q_m$; with that, we can then calculate the power to detect an impact expressed in effect size units.

From the power formulas, we can then arrive at MDES and sample size calculations.
From \citet{Dong2013}, in general the MDES can be estimated as

$$ MDES = MT_{df} \times \text{SE} / \text{VAR} $$

where $MT_{df}$ is the multiplier and is the sum of two t statistics based on degrees of freedom $df$.
For one-tailed tests, $MT_{df} = t_{\alpha} + t_{1-\beta}$ where $\alpha$ is the type I error rate and $\beta$ is the desired power.  For two-tailed tests, $MT_{df} = t_{\alpha/2} + t_{1-\beta}$.
For more details, see \citet[page 31]{Dong2013} or \citet[page 22]{Bloom2006}.
Manipulating this expression then results in sample size formulae.


\paragraph{A note on effect sizes.}
In describing the standard error of our estimators in terms of effect size, we need to carefully identify what we mean by an ``effect size.''
We commonly think of an effect size as the size of an impact relative to some reference amount of variation.
If the reference amount of variation is different, then the effect size, for the same absolute effect, will also be different.
This concern of what the denominator is can create some tension regarding some of the power formula, as we will note in the following sections.

In particular, the effect size formula can use either the variation in \emph{overall} control group, or just the within-group variation only.
Overall variation includes the student variation within each site, but also how the sites vary from each other.  Within-group variation is just this latter component.
We argue that overall variation is more natural.
We also believe all the formula should use the same definition of effect size.

Where this is most obviously a concern is with fixed effect regression.
In particular, with overall variation if we increase the ICC at level 2 or level 3, then there is less variation (relative to the reference variation) in level 1; thus an increased ICC will increase power for fixed effect regression.
This is simply the realized the gains of a blocked experiment.
If the effect size is calculated relative to within-group variation, this gain is not seen.
We will note how this plays out explicitly in the following sections.
An alternate approach is to have the $R^2$ measure include variance explained by the fixed effects.
To make the formula more directly comparable, we do not take this route, but one can obtain the same results by selecting an appropriate $R^2$ and then setting the ICC to 0.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 1 levels, Randomization: level 1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Design: 1 level, Randomization: level 1}

\subsection{Constant effects (d1.1\_m2cc)}

\textbf{PowerUp name:} Not applicable.

\textbf{Design:} 1-level design, randomization at level 1.

\textbf{Model:} constant intercepts, constant treatment effects, no school covariates.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &= \psi_{1,jkm} T_{ijk} + \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}
\end{align}

The standard error of the treatment effect estimate is:
\begin{align} Q_m = \sqrt{\frac{(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}}} . \end{align}

The degrees of freedom are:
\begin{align}\text{df}_m = J \bar{n} - g_{1,m} - 1.\end{align}

\paragraph{Sample size formula.} 
The sample size formulas are:
\begin{align}
J &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{1-R^2_{1,m}}{\bar{n} \bar{T} (1 - \bar{T})} \right)\\
\bar{n} &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{1-R^2_{1,m}}{J \bar{T} (1 - \bar{T})} \right) .
\end{align}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + C.ijk
\end{verbatim}

The randomization scheme is: simple random sampling.
\begin{verbatim}
T.x <- randomizr::simple_ra(N = nbar, prob = Tbar)
\end{verbatim}

The overall treatment effect is then the average of the \texttt{T.x} terms.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 2 levels, Randomization: level 1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Design: 2 levels, Randomization: level 1}

This section of designs comprise what are usually referred to as \emph{multisite experiments}.
In a multisite experiment, we have a collection of sites (here, schools) and are able to randomize the individuals within each site into treatment and control.
This allows for estimating an average impact for each site, in principle.
That being said, we are usually interested in estimating some overall summary of impacts across all our sites.

Critically, there are four different estimands we might consider: the average impact for persons vs. impact for sites, and the average impact of the sample we have vs. the average impact of the population where the sample came from.
When sites are equal sized, a common assumption for power calculations, the site and person average will be the same.
We therefore ignore it here.
For finite vs. super-population, we have to be more careful.\
Some estimation strategies target a finite-population estimand.
In this document, the ones that do are blocked\_i1\_2c and blocked\_i1\_2f.
The blocked\_i1\_2c estimation strategy does because it assumes a constant treatment impact; given this assumption, there is no uncertainty due to the sample itself as all samples have the same average impact by assumption.
The blocked\_i1\_2f estimation strategy allows each school to have an individually estimated impact, but due to using fixed effects rather than random, it is evaluating the sample at hand.
See \citet{Miratrix2020} for further, in-depth, discussion.
Those estimators that target the super-population need to take any uncertainty of the sample being representative of the super-population into account.
Here, the one that does this is blocked\_i1\_2r, with a model of each school having an average impact drawn from some random distribution.


Regardless of the model used to analyze these data, the randomization scheme is the same.
It is simple random sampling within each school, with proportion $\bar{n}\bar{T}$ units assigned to treatment in each school.
In R, we could randomize this way as so:
\begin{verbatim}
T.x <- randomizr::block_ra( S.id, prob = Tbar )
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked individual randomization 2 level designs, constant effects
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Constant effects (d2.1\_m2fc)}

\textbf{PowerUp name:} blocked\_i1\_2c

\textbf{Design:} 2-level design, randomization at level 1 (blocked).

\textbf{Model:} fixed intercepts, constant treatment effect, no school covariates.

When we assume constant effects, each school has its own fixed intercept for the control outcome, and the treatment effect is modeled as constant across schools.
We can also call this a fixed effects, constant treatment model \citep{Miratrix2020}.
This model allows some schools to have higher average outcomes than others (allowed for with the fixed effects), but assumes the treatment impact is the same.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &= \psi_{1,m} T_{ijk} + \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + u_{0,jkm}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \psi_{1,m} T_{ijk} + \mu_{0,km} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

PowerUp! gives that the standard error of the treatment effect estimate \emph{not} in effect size units is:
\begin{align}SE( \hat{\psi}_m ) = \sqrt{\frac{1}{\bar{T}(1 - \bar{T}) J \bar{n}}} \cdot \sigma_m .\end{align}

The degrees of freedom for our impact estimate are
\begin{align}\text{df}_m = J \bar{n} - g_{1,m} - J - 1.\end{align}


\paragraph{Converting to effect size.}
To convert the above to an effect size, we need to scale by overall variation.
Unfortunately, under a fixed effect model, there is no natural way to express this as we have not parameterized how the individual site intercepts, the $\delta_{0,jkm}$, vary.
PowerUp! therefore indexes by within group variation, which is
\begin{align*}
Var( Y_{ijkm}(0) | S_{id} ) &= \frac{ \sigma^2_m }{ 1 - R^2_{1,m} } \end{align*}
using the formula for $R^2_{1,m}$, capturing the predictive power of our individual-level covariates on the outcomes within a given school, of
\[ R^2_{1,m} = 1 - \frac{ \sigma^2_m }{ Var( Y_{ijkm}(0) |  S_{id} )} . \]
If we divide the above $SE(\hat{\psi}_m)$ formula by $\sigma^2_m/(1 - R^2_{1,m})$ we get  the reported MDES formula for $Q_m$ of
\[ 
\tilde{Q}_m = \sqrt{\frac{1-R^2_{1,m}}{\bar{T}(1 - \bar{T}) J \bar{n}}} ,
\]
with the tilde denoting that these effect size units are in terms of within-school variation, which is not often done.
Equivalently, this is assuming the blocks are all homogeneous, which both goes counter to the design principles of blocking and also is known to generally not hold when evaluating schools.
If we want the more classic effect size indexed by cross-site variation, we need to go further.

Assume we have an $\text{ICC}_{2,m}$, an assumed measure of how much overall (control-side) variation is at the school level:
\[ \text{ICC}_{2,m} = 1 - \frac{ Var( Y_{ijkm}(0) |  S_{id} ) ) }{ Var( Y_{ijkm}(0)) } . \]
This ICC is even defined for a finite sample, if we view the above as comparing the emperical (pooled) within-group variation to full variation.
Rearranging this gives $Var( Y_{ijkm}(0) ) = Var(  Y_{ijkm}(0) |  S_{id} ) /(1 - \text{ICC}_{2,m})$.

We can then plug this and the $R^2_{1,m}$ formula together to get
\[ Var( Y_{ijkm}(0) ) = \frac{ \sigma^2_m }{ 1 - R^2_{1,m} } \cdot \frac{1}{1- \text{ICC}_{2,m}} .\]
If we use this expression to scale our SE formula, we finally obtain
\begin{align} Q_m = \sqrt{\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}}} . \end{align}

\paragraph{Sample size formula.} 
The sample size formulas are:
\begin{align}
J &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{n} \bar{T} (1 - \bar{T})} \right)\\
\bar{n} &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{J \bar{T} (1 - \bar{T})} \right) .
\end{align}

The constant effects model means that we assume no treatment variation across our sites, i.e.,:
\begin{itemize}
\item $\omega_{2,m} = 0$
\end{itemize}

\paragraph{Difference from PowerUP.}

Note that the PowerUp formula assumes
\begin{itemize}
\item $\text{ICC}_{2,m} = 0$
\end{itemize}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + C.ijk + S.id
\end{verbatim}


\paragraph{PowerUp! Differences.}
PowerUp assumes there is no $\text{ICC}_{2,m}$ term while we allow for it.
This can be viewed as within (PowerUp!) vs. overall (this work) effect size metrics.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked individual randomization 2 level designs, fixed effects
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\subsection{Fixed effects (d2.1\_m2ff)}

\textbf{PowerUp name:} blocked\_i1\_2f

\textbf{Design:} 2-level design, randomization at level 1 (blocked).

\textbf{Model:} fixed intercepts, fixed treatment effects, no school covariates.

The constant effects model assumes treatment is the same for each block.
If it is not, and the blocks are different sizes or have different proportions of units treated, that estimator is precision-weighted and can thus be biased.
Some may instead choose to allow each school to have its own estimated impact, with a second averaging step where we calculate an overall site-average of the site specific impact estimates.

We do this by interacting our site fixed effects with treatment.
Now each school has its own fixed intercept for the control outcome, and each school also has its own fixed coefficient for the treatment effect.
We can also call this a fixed effects with interactions model \citep{Miratrix2020}.

In practice, the power calculations for this model will be the same as for constant effects, unless we allow for block size variation or variable proportion treated.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &= \psi_{1,jkm} T_{ijk} + \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + u_{0,jkm}\\
\nonumber \psi_{1,jkm} &= \mu_{1,km} + u_{1,jkm}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \left(\mu_{1,km} + u_{1,jkm}\right) T_{ijk} + \mu_{0,km} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}
The standard error of the treatment effect estimate (and therefore the sample size formula) are all the same as in the constant effects model:

\begin{align} Q_m = \sqrt{\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}}} . \end{align}

However, the degrees of freedom are different due to the additional interaction terms we need to estimate:
\begin{align}\text{df}_m = J \bar{n} - g_{1,m} - 2J.\end{align}

\paragraph{Sample size formula.} 
The sample size formulas are:
\begin{align}
J &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{n} \bar{T} (1 - \bar{T})} \right)\\
\bar{n} &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{J \bar{T} (1 - \bar{T})} \right) .
\end{align}

\paragraph{Difference from PowerUP.}

Note that the PowerUp formula assumes
\begin{itemize}
\item $\text{ICC}_{2,m} = 0$
\end{itemize}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 0 + T.x:S.id - T.x + C.ijk
\end{verbatim}
The overall treatment effect is then the average of the \texttt{T.x:S.id} interaction terms.

\paragraph{PowerUp! Differences.}
Just as the constant model, PowerUp assumes there is no $\text{ICC}_{2,m}$ term while we allow for it.
This can be viewed as within (PowerUp!) vs. overall (this work) effect size metrics.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked individual randomization 2 level designs, random effects
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\subsection{Random effects (d2.1\_m2fr)}

\textbf{PowerUp name:} blocked\_i1\_2r

\textbf{Design:} 2-level design, randomization at level 1 (blocked).

\textbf{Model:} random intercepts, random treatment effect, school covariates for intercept. Powerup also has school covariates for treatment effects to allow for modeling treatment effect heterogeneity; we do not include this.

If we are interested in generalizing from our sample to a superpopulation, we may wish to view the sample of schools themselves as representative of something larger.
Then, if some schools have different average impacts than other schools, we have to account for the possibility that our sample of schools has an overall average impact different from the target population.
We can account for this additional uncertainty with a random effects model that has a random effect for the school-level average impact.

The class random effects model gives each school both a random intercept for the control outcome, and  a random coefficient for the treatment effect.
This is also known as the RIRC model: random intercept, random coefficient.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &= \psi_{1,jkm} T_{ijk} + \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}\\
\nonumber \psi_{1,jkm} &= \mu_{1,km} + u_{1,jkm}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \left(\mu_{1,km} + u_{1,jkm}\right) T_{ijk} + \mu_{0,km} \\
\nonumber & + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
\begin{pmatrix} u_{0, jkm} \\ u_{1,jkm}\\ \end{pmatrix} &\sim
N\left(\begin{pmatrix} 0 \\ 0\\ \end{pmatrix}, \begin{pmatrix} \tau^2_{0,m} & \kappa^u_{mm} \tau_{0,m} \tau_{1,m} \\ \kappa^u_{mm} \tau_{1,m} \tau_{0,m} & \tau^2_{1,m} \\ \end{pmatrix}\right) \\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

In the fixed effects model, we set $u_{0,jkm}$ and $u_{1,jkm}$ to be fixed but constrained to have mean 0.
In the random effects model, we impose Normally distributed effects with variances $\tau_{0,m}^2$ and $\tau_{1,m}^2$ and correlation $\kappa_{mm}^u$. We note that the correlation structure $\kappa_{mm}^u$ does not heavily impact the distribution of the final test statistic.

We make an important note. In PowerUp!, they assume that school and district covariates also influence the treatment impact:
$$ \psi_{1,jkm} = \mu_{1,km} + \sum_{r=1}^{g_{2,m}} \phi_{mr} X_{jkmr} u_{1,jkm}$$

but we do not make this assumption.
The result of this is that we assume, in their notation, $R_{2T}^2=0$, which is the percent of treatment variation explained by level 2 covariates; we are exploiting none of the cross-site impact heterogeneity.
This assumption affects the first term in the standard error below.

The standard error of the treatment effect estimate is given by:
\begin{align}Q_m = \sqrt{\frac{\text{ICC}_{2,m} \omega_{2,m}}{J} + \frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}}}.\end{align}

Note that this formula is simply the prior formula with an additional term of $\text{ICC}_{2,m} \omega_{2,m} / J$.
This term captures the additional uncertainty from extrapolating from our sample to the super-population.
$Q_m$ with this model, therefore, will be larger than the prior models to the extent that the schools differ in terms of their impact variation (the $\text{ICC}_{2,m} \omega_{2,m}$ term is simply the variation in the random impact terms scaled by our overall variation).

The degrees of freedom are
\begin{align}\text{df}_m = J - g_{1,m} - 1.\end{align}

\paragraph{Sample size formula.} 
The sample size formulas are:
\begin{align}
J &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\text{ICC}_{2,m} \omega_{2,m} + \frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) \bar{n}} \right)\\
\bar{n} &= \frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T})\left(J \left(\frac{MT_{df}}{MDES}\right)^{-2} - \text{ICC}_{2,m} \omega_{2,m}\right)}
\end{align}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + X.jk + C.ijk + (1 + T.x | S.id)
\end{verbatim}

\paragraph{PowerUp! Differences.}
PowerUp allows for school covariates to influence the treatment impact, while we do not allow for this. In PowerUp terms, we assume $R^2_{2T} = 0$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 2 levels, Randomization: level 2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\section{Design: 2 levels, Randomization: level 2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Simple cluster randomization, 2 level design, random effects 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Random effects (d2.2\_m2rc)}

\textbf{PowerUp name:} simple\_c2\_2r


\textbf{Design:} 2-level design, randomization at level 2 (clusters).

\textbf{Model:} random intercepts, constant treatment effect for all schools, school covariates for intercept.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &=  \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \psi_{1,m} T_{jk} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \psi_{1,m} T_{jk} + \mu_{0,km} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
u_{0,jkm} &\sim N\left(0, \tau^2_{0,m}\right)\\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

The standard error of the treatment effect estimate is given by:
\begin{align}
Q_m = \sqrt{\frac{\text{ICC}_{2,m}(1 - R^2_{2,m})}{\bar{T}(1 - \bar{T}) J} + \frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}}}.\end{align}
The degrees of freedom are
\begin{align}\text{df}_m = J - g_{1,m} - 2.\end{align}

The constant effects model means that we assume no treatment variation across our sites, i.e.:
\begin{itemize}
\item $\omega_{2,m} = 0$
\end{itemize}


\paragraph{Sample size formula.} 
\begin{align}
J &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\frac{ \bar{n} \text{ICC}_{2,m}(1-R^2_{2,m}) + (1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) \bar{n}} \right)\\
\bar{n} &= \frac{(1-\text{ICC}_{2,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \left(\frac{MT_{df}}{MDES}\right)^{-2} - \text{ICC}_{2,m}(1-R^2_{2,m})  }
\end{align}


\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + X.jk + C.ijk + (1 | S.id)
\end{verbatim}

The randomization scheme is: simple random sampling occurs across schools, with $J\bar{T}$ schools assigned to treatment.
\begin{verbatim}
T.x <- randomizr::cluster_ra( S.id, prob = Tbar )
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 3 levels, Randomization: level 1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\section{Design: 3 levels, Randomization: level 1}

In these designs we have schools nested in districts, and students in schools.
The only difference here, as compared to blocked individual randomization with 2 levels, is the third level of district.
Since we are randomizing at the school level, this will only impact how we think about where variation is in terms of our effect size units.

In this context, if we are interested in the finite-sample impacts, other than for calculating our reference variation for effect sizes, the districts do not matter.
We can simply use the prior 2 level designs if we lump district variation into the $\text{ICC}_{2,m}$ terms.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked individual randomization 3 level designs, random effects
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Random effects (d3.1\_m3rr2rr)}

\textbf{PowerUp name:} blocked\_i1\_3r

\textbf{Design:} 3-level design, randomization at level 1 (blocked).

\textbf{Model:} random intercepts for district, random treatment effects for district, random intercepts for school, random effects for schools, school and district covariates for intercepts. Powerup also allows for school and district covariates for cross-site impact heterogeneity.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &= \psi_{1,jkm} T_{ijk} + \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}\\
\nonumber \psi_{1,jkm} &= \mu_{1,km} + u_{1,jkm} \\
\nonumber \mu_{0,km}  &= \Xi_{0,m} + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + w_{0,km}\\
\nonumber \mu_{1,km}  &= \Xi_{1,m} + w_{1,km}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \left(\Xi_{1,jkm} + w_{1,km} + u_{1,jkm}\right) T_{ijk} + \Xi_{0,km} \\
\nonumber & + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp}\\
 \nonumber &+ w_{0,km} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
\begin{pmatrix} u_{0, jkm} \\ u_{1,jkm}\\ \end{pmatrix} &\sim
N\left(\begin{pmatrix} 0 \\ 0\\ \end{pmatrix}, \begin{pmatrix} \tau^2_{0,m} & \kappa^u_{mm} \tau_{0,m} \tau_{1,m} \\ \kappa^u_{mm} \tau_{1,m} \tau_{0,m} & \tau^2_{1,m} \\ \end{pmatrix}\right) \\
\nonumber \begin{pmatrix} w_{0, km} \\ w_{1,km}\\ \end{pmatrix} &\sim
N\left( \begin{pmatrix} 0 \\ 0\\ \end{pmatrix}, \begin{pmatrix} \eta^2_{0,m} & \kappa^w_{mm} \eta_{0,m} \eta_{1,m} \\ \kappa^w_{mm} \eta_{1,m} \eta_{0,m} & \eta^2_{1,m} \\ \end{pmatrix}\right) \\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}


Similar to the two-level blocked model, in PowerUp! they further assume that school and district covariates also influence the treatment impact
\begin{align*}
\psi_{1,jkm} &= \mu_{1,km} + \sum_{r=1}^{g_{2,m}} \phi_{mr} X_{jkmr} u_{1,jkm}\\
\mu_{1,jkm} &= \xi_{1,m} + \sum_{s=1}^{g_{3,m}} \zeta_{mr} V_{kms} w_{1,km}\\
\end{align*}
but we do not make this assumption.


The standard error of the treatment effect estimate is given by:
\begin{align}Q_m = \sqrt{
\frac{\text{ICC}_{3,m} \omega_{3,m}}{K} +
\frac{\text{ICC}_{2,m} \omega_{2,m}}{JK} +
\frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) JK\bar{n}}
}.\end{align}
The degrees of freedom are
\begin{align}\text{df}_m = K - g_{3,m} - 1.\end{align}

This is a very conservative degrees of freedom.


\paragraph{Sample size formula.} 
\begin{align}
K &= \left(\frac{MT_{df}}{MDES}\right)^2 \left(\text{ICC}_{3,m} \omega_{3,m} + \frac{\text{ICC}_{2,m} \omega_{2,m}}{J} + \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}} \right)\\
J &= \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m}) + \bar{T}(1 - \bar{T}) \bar{n}\text{ICC}_{2,m} \omega_{2,m}}{\bar{T}(1 - \bar{T}) \bar{n}\left(K \left(\frac{MT_{df}}{MDES}\right)^{-2} - \text{ICC}_{3,m} \omega_{3,m}\right)}\\
\bar{n} &= \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T})\left(JK \left(\frac{MT_{df}}{MDES}\right)^{-2} - J\text{ICC}_{3,m} \omega_{3,m} - \text{ICC}_{2,m} \omega_{2,m}\right)}
\end{align}

\paragraph{Code syntax.}
\begin{verbatim}
Yobs ~ 1 + T.x + V.k + X.jk + C.ijk + (1 + T.x | S.id) + (1 + T.x | D.id) 
\end{verbatim}

The randomization scheme is: simple random sampling occurs within each school, with $\bar{n}\bar{T}$ units assigned to treatment in each school.
\begin{verbatim}
T.x <- randomizr::block_ra( S.id, prob = Tbar )
\end{verbatim}

\paragraph{PowerUp! Differences.}
PowerUp allows for school and district covariates to influence the treatment impact, while we do not allow for this. In PowerUp terms, we assume $R^2_{3T} = 0$ and $R^2_{2T} = 0$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 3 levels, Randomization: level 2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\section{Design: 3 levels, Randomization: level 2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked cluster randomization, 3 level design, fixed effects 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Fixed effects (d3.2\_m3ff2rc)}

\textbf{PowerUp name:} blocked\_c2\_3f

\textbf{Design:} 3-level design, randomization at level 2 (blocked cluster).

\textbf{Model:} fixed intercepts for districts, fixed treatment effects for districts, random intercepts for schools, constant effects for schools within a district, school covariates for intercept.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &=  \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \psi_{1,jkm} T_{jk} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}\\
\nonumber \mu_{0,km}  &= \Xi_{0,m}  + w_{0,km}\\
\nonumber \psi_{1,km} &= \Xi_{1,m} + w_{1,km}
%\nonumber \psi_{1,km} &= \mu_{1,km} \\
%\nonumber \mu_{1,km} &= \Xi_{1,m} + w_{1,km}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \left(\Xi_{1,m} + w_{1,km} \right) T_{jk} + \Xi_{0,m} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp}\\
\nonumber &+ w_{0,km} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
u_{0,jkm} &\sim N\left(0, \tau^2_{0,m}\right)\\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

The standard error of the treatment effect estimate is given by:
\begin{align}
Q_m = \sqrt{
\frac{\text{ICC}_{2,m}(1 - R^2_{2,m})}{\bar{T}(1 - \bar{T}) JK} +
\frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J K\bar{n}} }.\end{align}
The degrees of freedom are
\begin{align}\text{df}_m = K( J - 2) - g_{2,m}.\end{align}

This model assumes: no variation of impacts within schools, and no variation at the district level.
\begin{itemize}
\item $\omega_{2,m} = 0$
\item $R^2_3 = 0$
%\item $\text{ICC}_3 = 0$
\end{itemize}

\paragraph{Difference from PowerUP.}

Note that the PowerUp formula assumes
\begin{itemize}
\item $\text{ICC}_{3,m} = 0$
\end{itemize}

\paragraph{Sample size formula.} 
\begin{align}
K &= \left(\frac{MT_{df}}{MDES}\right)^2 \left( \frac{\text{ICC}_{2,m} (1-R_{2,m}^2)}{\bar{T}(1 - \bar{T}) J} + \frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}} \right)\\
J &= \frac{\bar{n}\text{ICC}_{2,m} (1-R_{2,m}^2) + (1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{n} \bar{T}(1 - \bar{T}) K \left(\frac{MT_{df}}{MDES}\right)^{-2} } \\
\bar{n} &= \frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T})J K \left(\frac{MT_{df}}{MDES}\right)^{-2} -  \text{ICC}_{2,m} (1-R_{2,m}^2)}
\end{align}


\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 0 + T.x * D.id - T.x + X.jk + C.ijk + (1 | S.id)
\end{verbatim}
The overall treatment effect is then the average of the T.x interaction terms.

The randomization scheme is: simple random sampling occurs within each district, with $\bar{J} \bar{T}$ schools assigned to treatment in each district, where $\bar{J}$ is the average number of schools in each district.
\begin{verbatim}
T.x <- randomizr::block_and_cluster_ra( blocks = D.id, clusters = S.id, prob = Tbar )
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Blocked cluster randomization, 3 level design, random effects 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\subsection{Random effects (d3.2\_m3rr2rc)}

\textbf{PowerUp name:} blocked\_c2\_3r

\textbf{Design:} 3-level design, randomization at level 2 (blocked cluster).

\textbf{Model:} random intercepts for districts, random treatment effect for districts, random intercepts for schools, constant effects for schools within a district, school and district covariates for intercept. Powerup also allows for district covariates for treatment effects.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}
Y_{ijkm} &=  \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}\\
\nonumber \mu_{0,km}  &= \Xi_{0,m} + \psi_{1,km} T_{k} + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + w_{0,km} \\
\nonumber \psi_{1,jkm} &= \Xi_{1,m} + w_{1,km}
%\nonumber \psi_{1,jkm} &= \mu_{1,km} \\
%\nonumber \mu_{1,km} &= \Xi_{1,m} + w_{1,km}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \left(\Xi_{1,m} + w_{1,km}\right) T_{jk} + \Xi_{0,m}\\
\nonumber & + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp}\\
\nonumber &+ w_{0,km} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
u_{0,jkm} &\sim N\left(0, \tau^2_{0,m}\right)\\
\nonumber \begin{pmatrix} w_{0, km} \\ w_{1,km}\\ \end{pmatrix} &\sim
N\left(\begin{pmatrix} 0 \\ 0\\ \end{pmatrix}, \begin{pmatrix} \eta^2_{0,m} & \kappa^w_{mm} \eta_{0,m} \eta_{1,m} \\ \kappa^w_{mm} \eta_{1,m} \eta_{0,m} & \eta^2_{1,m} \\ \end{pmatrix}\right) \\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

Similar to other blocked models model, in PowerUp! they further assume that district covariates also influence the treatment impact
\begin{align*}
\mu_{1,jkm} &= \xi_{1,m} + \sum_{s=1}^{g_{3,m}} \zeta_{mr} V_{kms} w_{1,km}
\end{align*}
but we do not make this assumption.

The standard error of the treatment effect estimate is given by:
\begin{align}
Q_m = \sqrt{
\frac{\text{ICC}_{3,m} \omega_{3,m}}{K} +
\frac{\text{ICC}_{2,m}(1 - R^2_{2,m})}{\bar{T}(1 - \bar{T}) J K } +
\frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J K\bar{n}} }.\end{align}
The degrees of freedom are
\begin{align}\text{df}_m = K - g_{3,m} - 1.\end{align}

Parameter assumptions
\begin{itemize}
\item $\omega_{2,m} = 0$
\end{itemize}


\paragraph{Sample size formula.} 
\begin{align}
K &= \left(\frac{MT_{df}}{MDES}\right)^2 \left( \text{ICC}_{3,m} \omega_3  +  \frac{\text{ICC}_{2,m} (1-R_{2,m}^2)}{\bar{T}(1 - \bar{T}) J} + \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}} \right)\\
J &=  \frac{\bar{n}\text{ICC}_{2,m} (1-R_{2,m}^2) + (1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{n} \bar{T}(1 - \bar{T})\left( K \left(\frac{MT_{df}}{MDES}\right)^{-2} -  \text{ICC}_{3,m} \omega_3\right)}\\
\bar{n} &= \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T})J \left(K \left(\frac{MT_{df}}{MDES}\right)^{-2} -  \text{ICC}_{3,m}\omega_{3,m}\right) -  \text{ICC}_{2,m} (1-R_{2,m}^2)}
\end{align}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + V.k + X.jk + C.ijk + (1 | S.id) + (1 + T.x | D.id)
\end{verbatim}

The randomization scheme is: simple random sampling occurs within each district, with $\bar{J} \bar{T}$ schools assigned to treatment in each district, where $\bar{J}$ is the average number of schools in each district.
\begin{verbatim}
T.x <- randomizr::block_and_cluster_ra( blocks = D.id, clusters = S.id, prob = Tbar )
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Design: 3 levels, Randomization: level 3
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage 
\section{Design: 3 levels, Randomization: level 3}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Simple cluster randomization, 3 level design, random effects 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Random effects (d3.3\_m3rc2rc)}

\textbf{PowerUp name:} simple\_c3\_3r

\textbf{Design:} 3-level design, randomization at level 3 (cluster).

\textbf{Model:} random intercepts for districts, constant treatment effects for districts, random intercepts for schools, constant treatment effects for schools, school and district covariates for intercept.

The model for estimating impacts on outcome $m$ is given by:
\begin{align}\label{eqn:bi12c_model}
Y_{ijkm} &=  \theta_{0,jkm} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp} + r_{ijkm}\\
\nonumber \theta_{0,jkm} &= \mu_{0,km} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + u_{0,jkm}\\
\nonumber \mu_{0,km}  &= \Xi_{0,m} + \psi_{1,m} T_{k} + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + w_{0,km}
\end{align}
with reduced form:
\begin{align}
Y_{ijkm} &= \psi_{1,m} T_{k} + \Xi_{0,m} + \sum_{s=1}^{g_{3,m}} \xi_{ms} V_{kms} + \sum_{r=1}^{g_{2,m}} \delta_{mr} X_{jkmr} + \sum_{p=1}^{g_{1,m}} \gamma_{mp} C_{ijkmp}\\
\nonumber &+ w_{0,km} + u_{0,jkm} + r_{ijkm}
\end{align}
and distributions:
\begin{align}
u_{0,jkm} &\sim N\left(0, \tau^2_{0,m}\right)\\
\nonumber w_{0,jkm} &\sim N\left(0, \eta^2_{0,m}\right)\\
\nonumber r_{ijkm} &\sim N\left(0, \sigma^2_m\right).
\end{align}

The standard error of the treatment effect estimate is given by:
\begin{align}
Q_m = \sqrt{
\frac{\text{ICC}_{3,m}(1 - R^2_{3,m})}{\bar{T}(1 - \bar{T}) K} +
\frac{\text{ICC}_{2,m}(1 - R^2_{2,m})}{\bar{T}(1 - \bar{T}) J K } +
\frac{(1-\text{ICC}_{2,m} - \text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J K\bar{n}} }.\end{align}
The degrees of freedom are
\begin{align}\text{df}_m = K - g_{3,m} - 2.\end{align}


The constant effects model means that we assume no treatment variation across our sites, i.e.:
\begin{itemize}
\item $\omega_{2,m} = 0$
\item $\omega_{3,m} = 0$
\end{itemize}



\paragraph{Sample size formula.} 
\begin{align}
K &= \left(\frac{MT_{df}}{MDES}\right)^2 \left( \frac{\text{ICC}_{3,m}(1-R_{3,m}^2)}{\bar{T}(1 - \bar{T})}  + \frac{\text{ICC}_{2,m} (1-R_{2,m}^2)}{\bar{T}(1 - \bar{T}) J} + \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T}) J \bar{n}} \right)\\
J&=   \frac{\bar{n}\text{ICC}_{2,m} (1-R_{2,m}^2) + (1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{n}\left(\bar{T}(1 - \bar{T}) K \left(\frac{MT_{df}}{MDES}\right)^{-2} - \text{ICC}_{3,m}(1-R_{3,m}^2)\right)} \\
\bar{n} &= \frac{(1-\text{ICC}_{2,m}-\text{ICC}_{3,m})(1-R^2_{1,m})}{\bar{T}(1 - \bar{T})JK \left(\frac{MT_{df}}{MDES}\right)^{-2} - J\text{ICC}_{3,m}(1-R_{3,m}^2) - \text{ICC}_{2,m} (1-R_{2,m}^2)}
\end{align}

\paragraph{Code syntax.}
The R model is
\begin{verbatim}
Yobs ~ 1 + T.x + V.k + X.jk + C.ijk + (1 | S.id) + (1 | D.id)
\end{verbatim}

The randomization scheme is: simple random sampling occurs across districts, with $K\bar{T}$ districts assigned to treatment.
\begin{verbatim}
T.x <- randomizr::cluster_ra( D.id, prob = Tbar )
\end{verbatim}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The Data Generation Process
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{The Data Generation Process}

We now discuss the assumed data generating process, indexed by parameters directly tied to the structural equations we use.
Let $\boldsymbol{x}_{ijk\cdot}$ be the vector collecting all outcomes $m$.

%We index as follows: $x_{ijkm}$ is variable $x$ for individual $i$ in school $j$ in district $k$ connected to outcome $m$.
%Covariates are indexed by outcomes $m$ because we assume each outcome has its own covariate associated with that outcome.
%For example, we may have outcomes for math, reading, and science, and pre-test values for each of these outcomes.
%We generate districts, schools in districts, and students in schools.

The data generating process is done in the following stages, outlined below.

\subsection{Determine DGP parameters}
\label{sec:dgp_param}

We have already discussed many parameters in Section~\ref{sec:notation}.
However, there are a few additional parameters required to generate data that do not directly feed into our equations for power or MDES, related to correlations, show in Table~\ref{tab:corr_param}.

The parameters used in this section need to be picked based on desired aggregate relationships of the full data.
See the next section for how to translate parameters such as ICC to the DGP parameters used below.

%The parameters of the DGP are shown in Table~\ref{tab:base_param}.

\begin{table}[ht!]
\begin{tabular}{p{1.5cm} | p{15cm}}
Param											& Description \\ \hline
$\mb{\rho}^D$									& Correlation matrix of district covariates $\mb{D}_{k\cdot}$ \\
$\mb{\rho}^{w_0}$								& Correlation matrix of district random effects $\mb{w}_{0,k\cdot}$ \\
$\mb{\rho}^{w_1}$								& Correlation matrix of district impacts $\mb{w}_{1,k\cdot}$\\
$\boldsymbol{\kappa}^{w}$						& Non-symmetric matrix of correlations between district random effects and impacts, composed of entries $\{\kappa_{m,m^\prime}^{w}\} = Corr(w_{0,km}, w_{1,km^\prime}$) \\ \hline
$\mb{\rho}^X$									& Correlation matrix of school covariates $\mb{X}_{jk\cdot}$\\
$\mb{\rho}^{u_0}$								& Correlation matrix of school random effects $\mb{u}_{0,jk\cdot}$\\
$\mb{\rho}^{u_1}$								& Correlation matrix of school impacts $\mb{u}_{1,jk\cdot}$\\
$\boldsymbol{\kappa}^{u}$						& Non-symmetric matrix of correlations between school random effects and impacts, composed of entries $\{\kappa_{m,m^\prime}^{u}\} = Corr(u_{0,jkm}, u_{1,jkm^\prime}$) \\ \hline
$\mb{\rho}^C$									& Correlation matrix of individual covariates $\mb{C}_{ijk\cdot}$\\
$\mb{\rho}^r$									& Correlation matrix of individual residuals $\mb{r}_{ijk\cdot}$
\end{tabular}
\label{tab:corr_param}
\caption{Correlation parameters}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Level 3
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Generate level 3 (district) data}

\subsubsection{Level 3 covariates}

Each outcome has its own district-level covariate, $V_{km}$ with $k = 1, \ldots, K$ and $m = 1, \ldots, M$.
We have $E(V_{km}) = 0$ and $Var(V_{km}) = 1$.
We assume a correlation between outcomes, so we define $\mb{\rho}^D$ is a $M \times M$ symmetric correlation matrix, with $\rho^D_{ij}$ is the value in row $i$ and column $j$ of the matrix $\mb{\rho}^D$.

\[ \left(
\begin{array}{c}
D_{k1}	\\
\vdots 	\\
V_{km}
\end{array}\right)
\sim
N\left[\left(
\begin{array}{c}
0		\\
\vdots 	\\
0
\end{array}\right),\left(
\begin{array}{ccc}
1 				& \cdots	& \rho^D_{1M}	\\
\vdots 			& 1			& \vdots 	\\
\rho^D_{M1}  	& \cdots	& 1
\end{array}
\right)\right].\]

\subsubsection{Level 3 outcomes}
\label{sec:level3_outcomes}

Let $\mu_{0,km}$ be the grand mean outcome under no treatment for district $k$, and
$\mu_{1,km}$ be the grand mean impact across schools for district $k$.
\begin{align}
\mu_{0,km} 	&= \Xi_{0,m} + \xi_{m} V_{km} + w_{0,km}  \\
\mu_{1,km} 	&= \Xi_{1,m} + w_{1,km}
\end{align}

Let $\Xi_{0,m}$ be the grand mean outcome under no treatment across all districts.
Without loss of generality, we will set $\Xi_{0,m} = 0$ for all $m$.
$\Xi_{1,km}$ is the grand mean impact across districts.

We now consider the distributions of random effects and impacts $w_{0,km}$ and $w_{1,km}$, starting with the marginal distributions.
We have $E(w_{0,km}) = 0$, $Var(w_{0,km}) = \eta_{0,m}^2$, and correlation between outcomes $M \times M$ matrix $\mb{\rho}^w$.
\[ \left(
\begin{array}{c}
w_{k1}	\\
\vdots 	\\
w_{kM}
\end{array}\right)
\sim
N\left[\left(
\begin{array}{c}
0		\\
\vdots 	\\
0
\end{array}\right),\left(
\begin{array}{ccc}
\eta_{0,1}^2						& \cdots		& \rho^{w_0}_{1M} \eta_{0,1} \eta_{0,M}	\\
\vdots 								& \ddots		& \vdots 	\\
\rho^{w_0}_{M1} \eta_{0,M} \eta_{0,1}  	& \cdots		& \eta_{0,M}^2
\end{array}
\right)\right].\]


Similarly, we have $E(w_{1,km}) = 0$, $Var(w_{1,km}) = \eta_{1,m}^2$, and correlation between outcomes $M \times M$ matrix $\mb{\rho}^{u_1}$.


We now consider the joint distribution, $(w_{0,km}, w_{1,km})$ are bivariate normal on the margin with correlation $\kappa^{w}_{mm}$:
\begin{equation}
\left(
\begin{array}{c}
w_{0,km}\\
w_{1,km}
\end{array} \right)
\sim
N\left[\left(
\begin{array}{c}
0\\
0\end{array}
\right),\left(
\begin{array}{cc}
\eta_{0,m}^2 									& \kappa^{w}_{mm} \eta_{0,m} \eta_{1,m} \\
\kappa^{w}_{mm}  \eta_{1,m} \eta_{0,m}  			& \eta_{1,m}^2
\end{array}
\right)\right], \label{eq:pairwise_corr_level3}
\end{equation}

But we want these values to be correlated across outcome (i.e., district average math test will be correlated with district average reading test).
We therefore generate the full set of district $k$'s random effects across all outcomes as a $2M$ vector of multivariate normal residuals:
\[ (w_{0,k1}, \ldots, w_{0,kM}, w_{1,k1}, \ldots, w_{1,km} ) \sim MVNorm( \vec{0}, \Sigma_{full}^{w} ) \]

with
\[ \Sigma_{full}^{u} =
\left(
\begin{array}{cc}
\Sigma_{w_0} 		& \Sigma_{w} \\
\Sigma_{w}^\prime 	& \Sigma_{w_1}
\end{array}
\right)
\]

and 
\[ \Sigma_{w_0} =
\left(
\begin{array}{ccc}
\eta_{0,1}^2 								& \cdots & \rho^{w_0}_{1M} \eta_{0,1} \eta_{0,M}  \\
\vdots 										& \ddots & \vdots \\
\rho^{w_1}_{M1} \eta_{0,M} \tau_{0,1} 		& \cdots & \eta_{0,M}^2
\end{array}
\right)
\]

\[ \Sigma_{w_1} =
\left(
\begin{array}{ccc}
\eta_{1,1}^2 							& \cdots & \rho^{w_1}_{1M} \eta_{1,1} \eta_{1,M}  \\
\vdots 									& \ddots & \vdots \\
\rho^{w_1}_{M1} \eta_{1,M} \eta_{1,1}	& \cdots & \eta_{1,M}^2
\end{array}
\right)
\]

For the form of the off-diagonal blocks, $\Sigma_{w}$, we first construct $M \times M$ matrix $\boldsymbol{\kappa}^{w}$ with entries $\{\kappa^{w}_{mm}\}$. 
The diagonals of this matrix are $\kappa^{w}_{mm}$, which have been previously defined as the correlation of the intercept and impact for outcome $m$.
The off-diagonals are, for $m \neq m^\prime$,
\[ \kappa^{w}_{m m^\prime} = cor( w_{0,km}, w_{1,km^\prime} ) .\]

We assume these are fixed across different values of $k$, i.e. that the correlations are constant across districts.

For example, consider a $3 \times 3$ case:
\[ \boldsymbol{\kappa}^{w} =
\left(
\begin{array}{ccc}
cor( w_{0,k1}, w_{1,k1} )	& cor( w_{0,k1}, w_{1,k2} ) & cor( w_{0,k1}, w_{1,k3} ) \\
cor( w_{0,k2}, w_{1,k1} )	& cor( w_{0,k2}, w_{1,k2} ) & cor( w_{0,k2}, w_{1,k3} ) \\
cor( w_{0,k3}, w_{1,k1} )	& cor( w_{0,k3}, w_{1,k2} ) & cor( w_{0,k3}, w_{1,k3} ) \\
\end{array}
\right)
\]

We note that this matrix does not necessarily have to be symmetric. 

This gives 
\[ \Sigma_{w} =
\left(
\begin{array}{ccc}
\kappa^{w}_{11} \eta_{0,1} \eta_{1,1} 	& \cdots & \kappa^{w}_{1M} \eta_{0,1}\eta_{1,M} \\
\vdots 									& \ddots & \vdots 							\\
\kappa^{w}_{M1} \eta_{0,M} \eta_{1,1} 	& \cdots & \kappa^{w}_{MM} \eta_{0,M}\eta_{1,M}
\end{array}
\right)
\]
Note how the diagonals correspond to the off-diagonal in Eq~\ref{eq:pairwise_corr_level3}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Level 2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Generate level 2 (school) data}

\subsubsection{Level 2 covariates}

Each outcome has its own school-level covariate.
For example, school average reading and math pre-tests, used for adjusting reading and math outcomes (in practice we might imagine adjusting each outcome with both, but in the case of few clusters this might not be a good idea due to degrees of freedom issues).

Index covariates as $X_{jkm}$ with $j = 1, \ldots, J$, $k = 1, \ldots, K$, and $m = 1, \ldots, M$.
As with the district-level covariates, we have $E(X_{jkm}) = 0$ and $Var(X_{jkm}) = 1$, and $\mb{\rho}^X$ is a $M \times M$ symmetric correlation matrix.

\subsubsection{Level 2 outcomes}
\label{sec:level2_outcomes}

Each school $j$ in district $k$ has its average outcome under no treatment $\theta_{0,jkm}$ and its average impacts $\psi_{1,jkm}$.
The mean outcome and average impact for school $j$ in district $k$ for outcome $m$ is
\begin{align}
\theta_{0,jkm} 	&= \mu_{0,km} + \delta_{m} X_{jkm} + u_{0,jkm}  \\
\psi_{1,jkm} 		&= \mu_{1,km} + u_{1,jkm}
\end{align}

We can easily convert from three-level to two-level models.
If there are no districts, then $\mu_{0,km} = \Xi_{0,m}$ and $\mu_{1,km} = \Xi_{1,m}$ for all $k$. Essentially, we set $w_{km} = 0$, $w_{km} = 0$, and $\xi_m = 0$ for all $k$. 

The $(u_{0,jkm}, u_{1,jkm})$ follow a multivariate Normal structure as in Section~\ref{sec:level3_outcomes}.
We have $Var(u_{0,jkm}) = \tau^2_{0,m}$ and $Var(u_{1,jkm}) = \tau^2_{1,m}$.  Also $Cov(\mb{u}_{0,jk\cdot}) = \mb{\rho}^{u_0}$ and $Cov(\mb{u}_{1,jk\cdot}) = \mb{\rho}^{u_1}$. Finally, they relate to each other with $Corr(u_{0,jkm}, u_{1,jkm^\prime}) = \kappa^{u}_{mm^\prime}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Level 1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Generate level 1 (individual) data}

\subsubsection{Level 1 covariates}

Individuals have individual level covariates, one for each outcome $C_{ijkm}$.
For example, group-mean centered reading and math scores.
We assume these are homoskedastic and have the same mean across sites.
As with previous covariates, we have $E(C_{ijkm}) = 0$ and $Var(C_{ijkm}) = 1$, and $\mb{\rho}^C$ is a $M \times M$ symmetric correlation matrix.

\subsubsection{Level 1 outcomes}

For each outcome, the outcome model for the individual is
\begin{align}
Y_{ijkm}(0) &= \theta_{0,jkm} + \gamma_m C_{ijkm} + r_{ijkm} \\
Y_{ijkm}(1) &= Y_{ijkm}(0) + \psi_{1,ijkm}
\end{align}

where $Y_{ijkm}(0)$ is potential outcome $m$ under no treatment for individual $i$ in school $j$ in district $k$, and $\psi_{ijkm}$ is the unit's individual causal effect.

We assume constant treatment effects for individuals in the same school, $\psi_{ijkm} = \psi_{1,jkm}$, but this assumption could be relaxed to allow for individual treatment-level heterogeneity.

As with previous covariates, we have $E(C_{ijkm}) = 0$ and $Var(C_{ijkm}) = 1$, and $\mb{\rho}^C$ is a $M \times M$ symmetric correlation matrix.

Finally, individual-level residuals are distributed $E(r_{ijkm}) = 0$ and $Var(r_{ijkm}) = 1$, and $\mb{\rho}^r$ is a $M \times M$ symmetric correlation matrix.

\subsubsection{Reduced form}

Putting the levels together, we have:
\begin{align}\label{eq:reduced}
Y_{ijkm}(0) &= \Xi_{0,m} + \xi_{m} V_{km} + \delta_{m} X_{jkm} + \gamma_m C_{ijkm} + w_{km} + u_{0,jkm} + r_{ijkm} \\
Y_{ijkm}(1) &= Y_{ijkm}(0) + \Xi_{1,m} + z_{km} + u_{1,jkm}
\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Algorithm
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Summary: Generating the full table of potential outcomes}

\begin{enumerate}
	\item For $k = 1, \ldots K$, and $m = 1, \ldots M$:
	\begin{enumerate}
		\item Generate district covariates $V_{km}$.
		\item Generate district residuals $w_{0,km}$ and $w_{1,km}$.
		\item Calculate grand means $\mu_{0,km}$ and $\mu_{1,km}$.
	\end{enumerate}
	\item For $j = 1, \ldots J$, and $m = 1, \ldots M$:
	\begin{enumerate}
		\item Generate school covariates $X_{jkm}$.
		\item Generate school residuals $u_{0,jkm}$ and $u_{1,jkm}$.
		\item Calculate grand means $\theta_{0,jkm}$ and $\psi_{1,jkm}$.
	\end{enumerate}
	\item For $i = 1, \ldots N$ and for $m = 1, \ldots M$:
	\begin{enumerate}
		\item Generate individual covariates, $C_{ijkm}$ 
		\item Generate individual residuals $r_{ijkm}$.
		\item Generate predicted baseline outcomes ($Y_{ijkm}(0)$ without residuals).
		\item Add residuals to the predicted outcomes to get $Y_{ijkm}(0)$ and calculate $Y_{ijkm}(1)$.
	\end{enumerate}
	
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Observed data
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Generate observed data}

Once we have our full set of potential outcomes, we generate treatment assignments to generate the observed outcomes.
We generate our treatment assignment, $T_{ijk}$ for all $i = 1, \ldots, n_j$ and $j = 1, \ldots, J$ and $k = 1, \ldots, K$.
Once we have our set of $T_{ijk}$ (no matter how they were obtained) we calculate the observed outcomes
\begin{equation}
Y_{ijkm}^{obs} = Y_{ijkm}(0) (1-T_{ijk}) + Y_{ijkm}(1) T_{ijk}
\end{equation}

\subsubsection{Randomization schemes}

We can assign at the district, school, or individual level depending on the design we are generating data for.

\begin{itemize}
\item Blocked individual randomization: simple random sampling occurs within each school, with $\bar{n}\bar{T}$ units assigned to treatment in each school.
\item Cluster 2-level randomization: simple random sampling occurs across schools, with $J \bar{T}$ schools assigned to treatment.
\item Cluster 3-level randomization: simple random sampling occurs across districts, with $K \bar{T}$ districts assigned to treatment.
\item Blocked cluster 3-level randomization: simple random sampling occurs within each district, with $J\bar{T}$ schools assigned to treatment in each district.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tuning the DGP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Tuning the DGP parameters}
\label{sec:tune}

We define two main types of parameters.
First, model parameters are those defined in Tables~\ref{tab:latent_param} and \ref{tab:corr_param}, and define the DGP.
Second, control or derived parameters, defined in Table~\ref{tab:derived_param} indirectly tune model parameters.
Control parameters are set by the user, which then influence model parameters which are fed into the DGP.
The mapping of control parameters to model parameters is in Table~\ref{tab:derived_param}.

We break our model parameters into sets:
\begin{itemize}
\item Set 1: $\{M, J, K, n_{jk}, \Xi_{0,m}, \mb{\rho}^D, \mb{\rho}^w, \mb{\rho}^z, \mb{\rho}^X, \mb{\rho}^u, \mb{\rho}^v, \mb{\rho}^C, \boldsymbol{\kappa}^{wz}, \boldsymbol{\kappa}^{uv}, p_j\}$ are set directly.
\item Set 2: $\{N, \mu_{0,m}, \mu_{1,m}, \theta_{0,jkm}, \psi_{1,jkm}, Y_{ijkm}(0), Y_{ijkm}(1) \}$ are functions of the parameters above that are set directly.
\item Set 3: $\{\Xi_{1,m}, \eta^2_{0,m}, \eta^2_{1,m}, \tau^2_{0,m}, \tau^2_{1,m}, \xi_m, \delta_m, \gamma_m\}$ are tuned through control parameters.
\end{itemize}

To translate from our control parameters to the model parameters we derive several relationships in the following.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Variance
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Calculating the variation in random effects and impacts}

We have variation at the individual, school, and district level.
We want to be able to tune the proportion of variation in each of these levels.
We are interested in the unconditional (covariate-free) ICC.

We have for the variance of the control side
\begin{align*}
Var_m( Y_{ijkm}(0) ) &= \xi_m^2 Var_m(V_{km}) + \delta_m^2 Var_m(X_{jkm}) + \gamma_m^2 Var_m(C_{ijkm}) + \eta^2_{0,m} + \tau^2_{0,m} + \sigma^2_m \\
&=  \xi_m^2 +  \eta^2_{0,m} + \delta_m^2  + \tau^2_{0,m} + \gamma_m^2 + \sigma^2_m.
\end{align*}

Looking at Equation~\ref{eq:reduced}, we see:

\[ \text{ICC}_{3,m} = \frac{Var(\theta_{0,km})}{ Var(Y_{ijkm}(0))} = \frac{\xi^2_m + \eta_{0,m}^2}{\left(\xi_m^2 +  \eta^2_{0,m}\right) + \left(\delta_m^2  + \tau^2_{0,m}\right) + \left(\gamma_m^2 + \sigma^2_m\right)}.\]

\[ \text{ICC}_{2,m} = \frac{Var(\mu_{0,jkm})}{ Var(Y_{ijkm}(0))} = \frac{\delta_m^2  + \tau_{0,m}^2}{\left(\xi_m^2 +  \eta^2_{0,m}\right) + \left(\delta_m^2  + \tau^2_{0,m}\right) + \left(\gamma_m^2 + \sigma^2_m\right)} .\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Covariate coefficients
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Calculating the covariate coefficients}

\subsubsection{Calculating the level 3 covariate coefficient $\xi_m$}

The regression coefficients for the level 3 covariates, $\xi_m$, is dictated by the desired $R^2$ values.
Thus, we would like to find $\xi_m$ as a function of the level-3 $R^2$.
We define $R^2_{3,m}$ as the proportion of variance between level 3 districts predicted by level 3 covariates.

We start with
\begin{align*}
R_{3,m}^2
&= 1 - \frac{Var(w_{0,km})}{Var(\mu_{0,km})} \\
&= 1 - \frac{\eta^2_{0,m}}{\xi_m^2 Var(V_{km}) + \eta^2_{0,m}},
\end{align*}
leading to
\begin{align*}
\xi_m  &= \sqrt{\frac{\eta^2_{0,m}R_{3,m}^2}{Var(V_{km})(1 - R_{3,m}^2)}} \\
&= \sqrt{\frac{\eta^2_{0,m}R_{3,m}^2}{1 - R_{3,m}^2}}.
\end{align*}


\subsubsection{Calculating the level 2 covariate coefficient $\delta_m$}

We start with our level-2 $R^2$ being defined as the proportion of variance in level-2 schools explained by level-2 covariates:

\[
R_{2,m}^2 = 1 - \frac{Var(u_{0,jkm})}{Var(\theta_{0,jkm} \mid S_{id})}
\]

where the conditioning $Var(\theta_{0,jkm} \mid S_{id})$ denotes the variance of outcomes \emph{within} a particular district.
This expands to

\[
R_{2,m}^2 = 1 - \frac{\tau^2_{0,m}}{\delta_m^2Var(X_{jkm} \mid S_{id}) + \tau^2_{0,m}}.
\]

Since our $X_{jkm}$ are generated independent of district, the conditional variance is the same as overall. This gives

\[
R_{2,m}^2 = 1 - \frac{\tau^2_{0,m}}{\delta_m^2Var(X_{jkm}) + \tau^2_{0,m}},
\]

Leading to
\begin{align*}
\delta_m  &= \sqrt{\frac{\tau^2_{0,m}R_{1,m}^2}{Var(X_{jkm})(1 - R_{2,m}^2)}} \\
&= \sqrt{\frac{\tau^2_{0,m}R_{2,m}^2}{1 - R_{2,m}^2}}.
\end{align*}

\subsubsection{Calculating the coefficient for the Level 1 variable ($\gamma_m$)}

Similar to level 2, we start with our level 1 $R^2$ being defined as the proportion of level 1 variance in individuals explained by level 1 covariates:
\[ R^2_{1,m} = 1 - \frac{ \sigma^2_m }{ var( Y_{ijkm}(0) \mid S_{id})},  \]
where the conditioning denotes the variance of outcomes \emph{within} a particular school.


We find

\begin{align*}
R^2_{1,m} &= 1 - \frac{ \sigma^2_m }{ \gamma_m^2 var( C_{ijkm} \mid S_{id} ) + \sigma^2_m }\\
&= 1 - \frac{ \sigma^2_m }{ \gamma_m^2 var( C_{ijkm}) + \sigma^2_m }\\
\gamma_m &= \sqrt{\frac{\sigma^2_m R_{1,m}^2}{var( C_{ijkm})(1 - R_{1,m}^2)}}\\
&= \sqrt{\frac{R_{1,m}^2}{1 - R_{1,m}^2}}\\
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Grand means
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Calculating the grand mean impacts $\Xi_{1,m}$}

This is a function of effect size.  The effect size is simply the overall impact in standard deviation units, with the standard deviation usually being the marginal standard deviation of the control side:

\[ \Xi_{1,m} = ES_m \cdot SD_m( Y_{ijkm}(0) ) \]

where $SD_m(Y_{ijkm}(0))$ denotes the standard deviation over $i$, $j$, and $k$ for fixed outcome $m$.
We have already noted $Var_m( Y_{ijkm}(0) ) = \xi_m^2 + \gamma_m^2  + \delta_m^2  +  \eta^2_{0,m} + \tau^2_{0,m} + \sigma^2_m$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Final results
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Final results}

We have produced a system of equations:

\begin{align*}
\text{ICC}_{3,m} &= \frac{\xi^2_m + \eta_{0,m}^2}{\xi_m^2 +  \eta^2_{0,m} + \delta_m^2  + \tau^2_{0,m} + \gamma_m^2 + 1}\\
\text{ICC}_{2,m} &= \frac{\delta_m^2  + \tau_{0,m}^2}{\xi_m^2 +  \eta^2_{0,m} + \delta_m^2  + \tau^2_{0,m} + \gamma_m^2 + 1}\\
\xi_m  &= \sqrt{\frac{\eta^2_{0,m}R_{3,m}^2}{1 - R_{3,m}^2}}\\
\delta_m &= \sqrt{\frac{\tau^2_{0,m}R_{2,m}^2}{1 - R_{2,m}^2}}\\
\gamma_m &= \sqrt{\frac{R_{1,m}^2}{1 - R_{1,m}^2}}
\end{align*}


We solve the system to find our model parameters:
\begin{align*}
\gamma_m^2 &= \frac{R_{1,m}^2}{1 - R_{1,m}^2}\\
\delta_m^2 &= \frac{R_{2,m}^2}{1-R_{1,m}^2} \frac{\text{ICC}_{2,m}}{1 - \text{ICC}_{3,m}- \text{ICC}_{2,m}}\\
\xi_m^2 &= \frac{R_{3,m}^2}{1-R_{1,m}^2} \frac{\text{ICC}_{3,m}}{1 - \text{ICC}_{3,m}- \text{ICC}_{2,m}}\\
\tau^2_{0,m}  &= \frac{1-R_{2,m}^2}{1-R_{1,m}^2} \frac{\text{ICC}_{2,m}}{1 - \text{ICC}_{3,m}- \text{ICC}_{2,m}}\\ 
\eta^2_{0,m} &= \frac{1-R_{3,m}^2}{1-R_{1,m}^2}\frac{\text{ICC}_{3,m}}{1 - \text{ICC}_{3,m}- \text{ICC}_{2,m}}
\end{align*}

For details on the algebra, see Section~\ref{sec:alg}.

And finally we set:
\begin{align*}
\eta^2_{1,m} &= \omega_{3,m} \left(\eta^2_{0,m} + \xi^2_m\right) \\
\tau^2_{1,m} &= \omega_{2,m} \left(\tau^2_{0,m} + \delta_m^2\right) \\
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendix
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Appendix: Algebra}
\label{sec:alg}

Let's start off with expressions we will later use:

\begin{align*}
\tau^2_{0,m}  &= \frac{\delta_m^2(1 - R_{2,m}^2)}{R_{2,m}^2}\\
\delta_m^2 + \tau^2_{0,m}  &= \delta_m^2 + \frac{\delta_m^2(1 - R_{2,m}^2)}{R_{2,m}^2}\\
&= \frac{\delta_m^2R_{2,m}^2 + \delta_m^2 - \delta_m^2R_{2,m}^2}{R_{2,m}^2}\\
\delta_m^2 + \tau^2_{0,m} &= \frac{\delta_m^2}{R_{2,m}^2}\\
\end{align*}

We also note:

\begin{align*}
\frac{\text{ICC}_{3,m}}{\text{ICC}_{2,m}} &= \frac{\xi^2_m + \eta_{0,m}^2}{\delta_m^2  + \tau_{0,m}^2}\\
\xi^2_m + \eta_{0,m}^2 &= \frac{\text{ICC}_{3,m}(\delta_m^2  + \tau_{0,m}^2)}{\text{ICC}_{2,m}}\\
&= \frac{\text{ICC}_{3,m}\delta_m^2}{R_{2,m}^2\text{ICC}_{2,m}}\\
\end{align*}

And finally it's easy to re-express $\gamma_m^2 + 1$:
\begin{align*}
\gamma_m &= \sqrt{\frac{R_{1,m}^2}{1 - R_{1,m}^2}}\\
\gamma_m^2 + 1 &= \frac{R_{1,m}^2}{1 - R_{1,m}^2} + 1\\
&= \frac{1}{1 - R_{1,m}^2}
\end{align*}


Let's start by plugging some of these into our expression for $ICC_2$ to find $\delta_m$:

\begin{align*}
\text{ICC}_{2,m} &= \frac{\delta_m^2  + \tau_{0,m}^2}{\xi_m^2 +  \eta^2_{0,m} + \delta_m^2  + \tau^2_{0,m} + \gamma_m^2 + 1}\\
&= \frac{\frac{\delta_m^2}{R_{2,m}^2}}{\frac{\text{ICC}_{3,m}\delta_m^2}{R_{2,m}^2\text{ICC}_{2,m}} + \frac{\delta_m^2}{R_{2,m}^2} + \gamma_m^2 + 1}\\
\frac{\delta_m^2}{R_{2,m}^2} &= \text{ICC}_{2,m} \left(\frac{\text{ICC}_{3,m}\delta_m^2}{R_{2,m}^2\text{ICC}_{2,m}} + \frac{\delta_m^2}{R_{2,m}^2} + \gamma_m^2 + 1\right) \\
\delta_m^2 &=  \text{ICC}_{3,m}\delta_m^2 + \text{ICC}_{2,m} \delta_m^2 + \text{ICC}_{2,m}R_{2,m}^2(\gamma_m^2 + 1)\\
\delta_m^2 &= \frac{\text{ICC}_{2,m}R_{2,m}^2(\gamma_m^2 + 1)}{1 - \text{ICC}_{3,m}- \text{ICC}_{2,m}}\\
&= \frac{\text{ICC}_{2,m}R_{2,m}^2}{(1 - \text{ICC}_{3,m}- \text{ICC}_{2,m})(1-R_{1,m}^2)}
\end{align*}


Proceeding by a similar method, we can use $ICC_3$ to find $\xi_m$:

\begin{align*}
\xi_m^2 &= \frac{\text{ICC}_{3,m}R_{3,m}^2}{(1 - \text{ICC}_{3,m}- \text{ICC}_{2,m})(1-R_{1,m}^2)}
\end{align*}

Now we can plug in to find $\tau^2_{0,m}$:

\begin{align*}
\tau^2_{0,m}  &= \frac{\delta_m^2(1 - R_{2,m}^2)}{R_{2,m}^2}\\
&= \frac{\text{ICC}_{2,m}R_{2,m}^2}{(1 - \text{ICC}_{3,m}- \text{ICC}_{2,m})(1-R_{1,m}^2)}\frac{(1 - R_{2,m}^2)}{R_{2,m}^2}\\
&= \frac{\text{ICC}_{2,m}(1-R_{2,m}^2)}{(1 - \text{ICC}_{3,m}- \text{ICC}_{2,m})(1-R_{1,m}^2)}
\end{align*}

And similarly:

\begin{align*}
\eta^2_{0,m} &= \frac{\text{ICC}_{3,m}(1-R_{3,m}^2)}{(1 - \text{ICC}_{3,m}- \text{ICC}_{2,m})(1-R_{1,m}^2)}
\end{align*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\bibliography{pump}
%\bibliographystyle{plain}


\end{document}
