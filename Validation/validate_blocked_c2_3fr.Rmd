---
title: "Validate Power: blocked_c2_3fr"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
output:
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---
# Purpose

This document lays out results for estimating statistical power and minimum detectable effect size (MDES) for:
Blocked RCT, with 3 levels, and randomization done at level 2 (school level). This document contains models assuming constant fixed treatment effects and random treatment effects.

We compare results of the derived methods against Monte Carlo Simulations & the PowerUp R package on power. The methods are derived by Kristin Porter as outlined in the paper/s here (Add reference section).

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))
params.default <- user.params.list

# validate MDES and sample size?
validate.mdes.ss = FALSE
```

```{r}
# set document-level parameters
user.params.list[['K']] <- params.default[['K']]
user.params.list[['omega.2']] <- 0
user.params.list[['omega.3']] <- params.default[['omega.3']]
```


# Power Validation

In this section, we validate power results for different definitions of power and different adjustment procedures.

If you are previewing this in html, please click on the code section to review more detailed parameters.

This section sets up the simulation-level parameters, such as how many monte carlo samples to draw.

```{r sim.params}
# print(sim.params.list)
```

```{r user.params}
# print(user.params.list)
```

### Setup 1: School size 100

Main parameters:

* n.j = 100
* M = 3
* J = 20
* K = 4
* rho = (0.5, 0.5, 0.5)
* MDES = (0.125, 0.125, 0.125)
* R2.1 = (0, 0, 0)
* R2.2 = (0, 0, 0)
* R2.3 = (0, 0, 0)
* ICC.2 = (0, 0, 0)
* ICC.3 = (0, 0, 0)
* Omega.2 = 0.5
* Omega.3 = 0.5

`r colorize("Individual Statistical power is estimated to be around 0.8. Please check the table below for estimations of other definitions of statistical power. Across all power definitions, estimation results across the __PUMP__ package, __Monte Carlo Simulation__ results and __PowerUp__ package are about the same as detailed below.", "green")`

```{r nj100}
user.params.list[['n.j']] <- 100
```

```{r 3f.nj100}
design <- "blocked_c2_3f"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_c2_3f_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_c2_3f_nj100_power_plot)
```

```{r 3r.nj100}
design <- "blocked_c2_3r"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_c2_3r_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_c2_3r_nj100_power_plot)
```

### Setup 2: School size 75

* n.j = 75

```{r nj75}
user.params.list[['n.j']] <- 75
```

```{r 3f.nj75}
design <- "blocked_c2_3f"
blocked_c2_3f_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_nj75_power_plot)
```

```{r 3r.nj75}
design <- "blocked_c2_3r"
blocked_c2_3r_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_nj75_power_plot)
```

### Setup 3: School size 50

* n.j = 50

```{r nj50}
user.params.list[['n.j']] <- 50
```


```{r 3f.nj50}
design <- "blocked_c2_3f"
blocked_i1_3f_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3f_nj50_power_plot)
```

```{r 3r.nj50}
design <- "blocked_c2_3r"
blocked_i1_3r_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3r_nj50_power_plot)
```

# Varying R2

R2.1 = 0.6, 0.6, 0.6

```{r r2.10.6}
user.params.list[['R2.1']] <- rep(0.6, M)  
```

```{r 3f.r2.10.6}
design <- "blocked_c2_3f"
blocked_c2_3f_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.1_power_plot)
```

```{r r2.1.reset}
user.params.list[['R2.1']] <- params.default[['R2.1']]  
```

R2.2 = 0.6, 0.6, 0.6

```{r r2.20.6}
user.params.list[['R2.2']] <- rep(0.6, M)  
```

```{r 3f.r2.20.6}
design <- "blocked_c2_3f"
blocked_c2_3f_r2.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.2_power_plot)
```

```{r r2.2.reset}
user.params.list[['R2.2']] <- params.default[['R2.2']]  
```

R2.3 = 0.6, 0.6, 0.6

```{r r2.30.6}
user.params.list[['R2.3']] <- rep(0.6, M)  
```

```{r 3f.r2.30.6}
design <- "blocked_c2_3f"
blocked_c2_3f_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.3_power_plot)
```

```{r r2.3.reset}
user.params.list[['R2.3']] <- params.default[['R2.3']] 
```

# Varying rho

rho.default = 0.2

```{r rho0.2tPMnj50}
rho.default <- 0.2
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <- rho.default
```

```{r 3f.rho0.2}
design <- "blocked_c2_3f"
blocked_c2_3f_rho0.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_rho0.2_power_plot)
```

rho.default = 0.8

```{r rho0.8}
rho.default <- 0.8
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```

```{r 3f.rho0.8}
design <- "blocked_c2_3f"
blocked_c2_3f_rho0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_rho0.8_power_plot)
```

```{r rho.reset}
# reset
rho.default <- params.default[['rho.default']]
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```


# Varying true positives

MDES = 0.125, 0, 0

```{r MDES0.12500}
user.params.list[['ATE_ES']] <- c(0.125, 0, 0)
```

```{r 3f.MDES0.12500}
design <- "blocked_c2_3f"
blocked_c2_3f_mdes0.1250.00.0.00_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_mdes0.1250.00.0.00_power_plot)
```

```{r MDES.reset}
user.params.list[['ATE_ES']] <- params.default[['ATE_ES']]
```

# Varying ICC

ICC.2 = c(0.7, 0.7, 0.7)

```{r ICC20.7}
user.params.list[['ICC.2']] <- rep(0.7, M)
```

```{r 3f.ICC20.7}
design <- "blocked_c2_3f"
blocked_c2_3f_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_ICC2.0.7_power_plot)
```

```{r ICC2.reset}
user.params.list[['ICC.2']] <- params.default[['ICC.2']]
```

ICC.3 = c(0.7, 0.7, 0.7)

```{r ICC30.7}
user.params.list[['ICC.3']] <- rep(0.7, M)
```

```{r 3f.ICC30.7}
design <- "blocked_c2_3f"
blocked_c2_3f_ICC3.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_ICC3.0.7_power_plot)
```

```{r ICC3.reset}
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
```

# Varying Omega

omega.3 = 0.8

```{r omega30.8}
user.params.list[['omega.3']] <- 0.8
```

```{r 3f.omega30.8}
design <- "blocked_c2_3f"
blocked_i1_3f_omega3.0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3f_omega3.0.8_power_plot)
```

```{r 3r.omega30.8}
design <- "blocked_c2_3r"
blocked_i1_3r_omega3.0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0.8_power_plot)
```

```{r omega3.reset}
user.params.list[['omega.3']] <- params.default[['omega.3']]
```