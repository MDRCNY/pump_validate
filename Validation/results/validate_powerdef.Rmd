---
title: "Validate Power: MDES and SS power definitions"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))
params.default <- user.params.list
```

```{r}
# assumptions
user.params.list[['omega.2']] <- 0
user.params.list[['J']] <- 20
user.params.list[['K']] <- 10
user.params.list[['nbar']] <- 50
user.params.list[['R2.3']] <- rep(0, M)

sim.params.list[['S']] <- 1000
```

Default parameters:

* M = `r user.params.list[['M']]`
* J = `r user.params.list[['J']]`
* K = `r user.params.list[['K']]`
* rho: $\rho$ =  `r user.params.list[['rho.default']]`
* ATE ES = `r user.params.list[['ATE_ES']]`
* R21, R22: $R^2_1$ = `r user.params.list[['R2.1']]`, $R^2_2$ = `r user.params.list[['R2.2']]`
* ICC2: $\text{ICC}_2$ = `r user.params.list[['ICC.2']]`
* Omega: $\omega_2$ = `r user.params.list[['omega.2']]`, $\omega_3$ = `r user.params.list[['omega.3']]`

Parameters by model type:

* R23: $R^2_3 = 0$ for fixed effects model, $R^2_3$ = `r user.params.list[['R2.3']]` for random effects model
* ICC3: $\text{ICC}_3 = 0$ for fixed model, $\text{ICC}_3$ = `r user.params.list[['ICC.3']]` for random effects model

# Power Validation

```{r raw.D1indiv}
design <- "d3.2_m3ff2rc"
user.params.list$ATE_ES <- rep(0.1, 3)
user.params.list$J <- 3
user.params.list$K <- 22
user.params.list$nbar <- 150
user.params.list$R2.1 <- 0.1
user.params.list$R2.2 <- 0.7
user.params.list$ICC.2 <- 0.05
user.params.list$ICC.3 <- 0.4
user.params.list$rho <- 0.4
d3.2_m3ff2rc_rawD1indiv_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_rawD1indiv_power_plot)
```

```{r bonf.D1indiv}
design <- "d3.2_m3ff2rc"
user.params.list$ATE_ES <- rep(0.1, 3)
user.params.list$J <- 4
user.params.list$K <- 17
user.params.list$nbar <- 160
user.params.list$R2.1 <- 0.3
user.params.list$R2.2 <- 0.75
user.params.list$ICC.2 <- 0.05
user.params.list$ICC.3 <- 0.4
user.params.list$rho <- 0.4
d3.2_m3ff2rc_bonfD1indiv_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_bonfD1indiv_power_plot)
```

```{r bonf.min1}
design <- "d3.2_m3ff2rc"
user.params.list$ATE_ES <- rep(0.1, 3)
user.params.list$J <- 4
user.params.list$K <- 16
user.params.list$nbar <- 150
user.params.list$R2.1 <- 0.25
user.params.list$R2.2 <- 0.75
user.params.list$ICC.2 <- 0.05
user.params.list$ICC.3 <- 0.4
user.params.list$rho <- 0.4
d3.2_m3ff2rc_bonfmin1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_bonfmin1_power_plot)
```

```{r bonf.complete}
design <- "d3.2_m3ff2rc"
user.params.list$ATE_ES <- rep(0.1, 3)
user.params.list$J <- 4
user.params.list$K <- 16
user.params.list$nbar <- 150
user.params.list$R2.1 <- 0.25
user.params.list$R2.2 <- 0.75
user.params.list$ICC.2 <- 0.05
user.params.list$ICC.3 <- 0.4
user.params.list$rho <- 0.4
d3.2_m3ff2rc_bonfcomplete_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(d3.2_m3ff2rc_bonfcomplete_power_plot)
```

# MDES

```{r}
user.params.list <- params.default

# assumptions
user.params.list[['omega.2']] <- 0
user.params.list[['omega.3']] <- 0

# param settings to have a decent level of power
user.params.list[['J']] <- 40
user.params.list[['K']] <- 20
user.params.list[['ATE_ES']] <- rep(0.25, M)
user.params.list[['ICC.3']] <- rep(0.1, M)
user.params.list[['ICC.2']] <- rep(0.1, M)
```

```{r mdes.D1indiv}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.min1}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.min2}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.complete}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_complete')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

# Sample Size

## Sample Size J

```{r ss.D1indiv.J}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min1.J}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min2.J}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.complete.J}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

## Sample Size K

```{r ss.D1indiv.K}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_K_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_K_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min1.K}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_K_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_K_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min2.K}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_K_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_K_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.complete.K}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_K_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_K_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

## Sample Size nbar

```{r ss.D1indiv.nbar}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_nbar_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_nbar_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min1.nbar}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_nbar_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_nbar_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.min2.nbar}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_nbar_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_nbar_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r ss.complete.nbar}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_nbar_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_nbar_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


# Changing correlation

## correlation = 0

```{r rho0}
user.params.list[['rho']] <- 0
```

```{r mdes.min1.rho0}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.complete.rho0}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_complete')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.min1.J.rho0}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.complete.J.rho0}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

## correlation = 0.8

```{r rho0.8}
user.params.list[['rho']] <- 0.8
```

```{r mdes.min1.rho0.8}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.complete.rho0.8}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_complete')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.min1.J.rho0.8}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.complete.J.rho0.8}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


## correlation = 1

```{r rho1}
user.params.list[['rho']] <- 1
```

```{r mdes.min1.rho1}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```

```{r mdes.complete.rho1}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'mdes_complete')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_mdes_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_mdes_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.min1.J.rho1}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min1')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_min1_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_J_min1_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


```{r ss.complete.J.rho1}
design <- "d3.3_m3rc2rc"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_J_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  d3.3_m3rc2rc_sample_J_complete_results <- readRDS(sample.file)
  pander::pandoc.table(
    d3.3_m3rc2rc_sample_2_complete_results,
    style = "grid", split.tables = 100, row.names = FALSE,
    caption = design
  )
}
```


