---
title: "Validate Power: cluster_c2_2r"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
output:
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---

This document lays out results for estimating statistical power and minimum detectable effect size (MDES) for:
Cluster RCT, with 2 levels, and randomization done at level 2 (school level). This document contains models assuming random treatment effects.

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))
params.default <- user.params.list

# validate MDES and sample size?
validate.mdes.ss = FALSE
```

```{r universal.params}
design <- "simple_c2_2r"
# assumptions
user.params.list[['omega.2']] <- 0
user.params.list[['K']] <- 1
user.params.list[['ICC.3']] <- rep(0, M)

# params to help have a decent power
user.params.list[['ICC.2']] <- rep(0.1, M)
user.params.list[['J']] <- 40
```

# Power Validation

```{r sim.params}
# print(sim.params.list)
```

```{r user.params}
# print(user.params.list)
```

Default parameters:

* M = `r user.params.list[['M']]`
* J = `r user.params.list[['J']]`
* rho: $\rho$ =  `r user.params.list[['rho.default']]`
* ATE ES = `r user.params.list[['ATE_ES']]`
* R2: $R^2_1$ = `r user.params.list[['R2.1']]`, $R^2_2$ = `r user.params.list[['R2.2']]`
* Omega: $\omega_2 = 0$
* ICC: $\text{ICC}_2$ = `r user.params.list[['ICC.2']]` 

## Varying school size

```{r nj100}
user.params.list[['n.j']] <- 100
```

$\bar{n}$ = `r user.params.list[['nbar']]`

```{r 2r.nj100}
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
cluster_c2_2r_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(cluster_c2_2r_nj100_power_plot)
```

```{r nj75}
user.params.list[['n.j']] <- 75
```

$\bar{n}$ = `r user.params.list[['nbar']]`

```{r 2r.nj75}
cluster_c2_2r_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_nj75_power_plot)
```

```{r nj50}
user.params.list[['n.j']] <- 50
```

$\bar{n}$ = `r user.params.list[['nbar']]`


```{r 2r.nj50}
cluster_c2_2r_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_nj50_power_plot)
```


## Varying R2

```{r r2.10.6}
user.params.list[['R2.1']] <- rep(0.6, M)  
```

$R^2_1 =$ `r user.params.list[['R2.1']]`

```{r 2r.r2.10.6}
cluster_c2_2r_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_r2.1_power_plot)
user.params.list[['R2.1']] <- params.default[['R2.1']]  
```

```{r r2.20.6}
user.params.list[['R2.2']] <- rep(0.6, M)  
```

$R^2_2 =$ `r user.params.list[['R2.2']]`

```{r 2r.r2.20.6}
cluster_c2_2r_r2.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_r2.2_power_plot)
user.params.list[['R2.2']] <- params.default[['R2.2']]  
```


## Varying rho

```{r rho0.2}
rho.default <- 0.2
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <- rho.default
```

$\rho =$ `r user.params.list[['rho.default']]`

```{r 2r.rho0.2}
cluster_c2_2r_rho0.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_rho0.2_power_plot)
```

```{r rho0.8}
rho.default <- 0.8
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```

$\rho =$ `r user.params.list[['rho.default']]`

```{r 2r.rho0.8}
cluster_c2_2r_rho0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_rho0.8_power_plot)
# reset
rho.default <- params.default[['rho.default']]
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.X']] <- user.params.list[['rho.C']] <-rho.default
user.params.list[['rho.u']] <- user.params.list[['rho.v']] <- user.params.list[['rho.r']] <-rho.default
```

## Varying true positives

```{r MDES0.12500}
user.params.list[['ATE_ES']] <- c(0.125, 0, 0)
```

ATE (ES) = `r user.params.list[['ATE_ES']]`


```{r 2r.MDES0.12500}
cluster_c2_2r_mdes0.1250.00.0.00_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_mdes0.1250.00.0.00_power_plot)
user.params.list[['ATE_ES']] <- params.default[['ATE_ES']]
```

## Varying ICC

```{r ICC20.8}
user.params.list[['ICC.2']] <- rep(0.7, M)
```

$\text{ICC}_2$ = `r user.params.list[['ICC.2']]`

```{r 2r.ICC20.8}
cluster_c2_2r_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(cluster_c2_2r_ICC2.0.7_power_plot)
user.params.list[['ICC.2']] <- params.default[['ICC.2']]
```