---
title: "Verification for 2-Level RCT"
author: "Deni Chen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document:
    toc: true
    toc_float: true
    number_sections: true
    #theme: cerulean
---

# Sourcing all needed code 

```{r chunk1_source }
# source functions for computing power, MDES, sample size that correspond to design of focus
source("powerFunctions.R")

# source functions for simulations that correspond to design of focus
#source("MonteCarloSimulation.R")
```


# Design and parameter specifications

```{r chunk2_specifications}
#DC: this code is from the verification template - should we use it instead of the code below that was taken from powerFunctions.Rmd?

#ncl<-24
#rho<-c(0.2,0.5,0.8)
#M <- c(1,3,6)
#sigma<-matrix(rep(rho,M*M),nrow=M,ncol=M)
#diag(sigma)<-1
#mdes_<-c(0.125,0.5)
#MDES1<-c(rep(mdes_,M))    #generates an error- needs looping?
#MDES2<-c(rep(mdes_,M*2/3),rep(0,M/3))
#MDES3<-c(rep(mdes_,M/3),rep(0,M*2/3))
#p <- 0.5
#R2.1 <- c(0,0.5)
#R2.2 <- c(0,0.5)
#numCovar.1 <- c(0,1)
#numCovar.2 <- c(0,1)
#ICC <- c(0,0.5)
#J <- c(20,50)
#n.j <- c(20,50)
#alpha = 0.05


#from powerfunctions example 
 ncl<-24
  rho<-0.5
  M <- 3
  sigma<-matrix(rep(rho,M*M),nrow=M,ncol=M)
  diag(sigma)<-1
  MDES<-c(rep(0.185,M))
#  MDES<-c(rep(0.3,M*2/3),rep(0,M/3))
  p <- 0.5
  R2.1 <- 0
  R2.2 <- 0
  numCovar.1 <- 0
  numCovar.2 <- 0
  ICC <- 0
  J <- 50
  n.j <- 20
  alpha = 0.05

  
  
  

  
  
```

# Verify power calculations and capture run times

## Maybe different chunk for each design specification (e.g, constant, fixed, random effects)

### The simulations will take a long time so may want to run these separately, and pull results into this markdown??

```{r chunk3_verifyPower}
# loop through combinations (don't need all crossed - TBD)

    #DC: Should we loop based on the parameters above?

  # run new
  # 2 level RCT constant effects
  power.blockedRCT.2(M, MDES, J, n.j,
                      p, alpha, numCovar.1, numCovar.2, R2.1, R2.2, ICC, 
                      mod.type = "constant", sigma, omega = NULL,
                      tnum=10000, snum=2, ncl)
    
  # run simulations
  simpwr
  
  # for M=1, look up in Power-Up

  # create table of results and check for if within TBD margin of error

  # create table of run times

```

# Verify MDES calculations and capture run times

```{r chunk4_verifyMDES}

# Specify power estimates that match those obtained in chunk3_verifyPower (grab from final table/matrix) and corresponding sample size - and check that returned MDES is correct

#generate MDES - code has lots of warnings/errors - unfinished?
#MDES.blockedRCT.2(M=M, numFalse = M, J=50, n.j=20, power=0.80, power.definition = "min2", MTP = "BF", marginError = 0.005,
#                          p=0.5, alpha=0.05, numCovar.1=0, numCovar.2=0, R2.1=0, R2.2=0, ICC=0, 
#                          mod.type="constant", sigma=sigma, omega=NULL,
#                          tnum = 10000, snum=2, ncl=24)


```

# Verify sample size calculations and capture run times

```{r chunk4_verifySampleSize}

# Specify power estimates that match those obtained in chunk3_verifyPower (grab from final table/matrix) and corresponding MDES - and check that returned sample size is correct

# repeat for number of blocks, number within blocks, etc. 

```

# ?? Verify error messages


```{r chunk4_verifyErrorsWarnings}

# Pass in anticipated mistakes and show return of error messages/warnings?

```



## QUESTIONS
###   Do we use the code from the verification template for specification?
###     if so, how do we loop through these parameters? Some of this code generates an error
###   Are the specifications in chunk3 the same for MDES SS, and MC? Do we need to make new specifications for those chunks?
###   Function to generate MDES is not finalized in powerFunctions - need to revise and input 
###   Function to generate sample size is not created yet

###  powerFunctions: are the functions in this RMD to be used for all designs? Or do we need to create a separate function (power, MDES, ss) for each design? Naming conventions for these functions

###   MC code is sourced but the .R file needs to be edited-
###     Take out the specifications in .R
###     Are we using the same specifications from the power function in the MC function?


