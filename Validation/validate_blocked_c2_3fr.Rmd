---
title: "Validate Power: blocked_c2_3fr"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---

Design: Blocked Cluster RCT, with 3 levels, and randomization done at level 2 (school level).

Models: random and fixed treatment effects.

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))
params.default <- user.params.list
```

```{r}
# assumptions
user.params.list[['omega.2']] <- 0
user.params.list[['J']] <- 20
user.params.list[['K']] <- 10
user.params.list[['nbar']] <- 50

sim.params.list[['S']] <- 1000

params.default <- user.params.list
```

Default parameters:

* M = `r user.params.list[['M']]`
* J = `r user.params.list[['J']]`
* K = `r user.params.list[['K']]`
* rho: $\rho$ =  `r user.params.list[['rho.default']]`
* ATE ES = `r user.params.list[['ATE_ES']]`
* R21, R22: $R^2_1$ = `r user.params.list[['R2.1']]`, $R^2_2$ = `r user.params.list[['R2.2']]`
* ICC2: $\text{ICC}_2$ = `r user.params.list[['ICC.2']]`
* Omega: $\omega_2$ = `r user.params.list[['omega.2']]`, $\omega_3$ = `r user.params.list[['omega.3']]`

Parameters by model type:

* R23: $R^2_3 = 0$ for fixed effects model, $R^2_3$ = `r user.params.list[['R2.3']]` for random effects model
* ICC3: $\text{ICC}_3 = 0$ for fixed model, $\text{ICC}_3$ = `r user.params.list[['ICC.3']]` for random effects model

# Power Validation

## Varying school size

```{r nj100}
user.params.list[['nbar']] <- 100
```

$\bar{n}$ = `r user.params.list[['nbar']]`

```{r 3f.nj100}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_c2_3f_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_c2_3f_nj100_power_plot)
```

```{r 3r.nj100}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
blocked_c2_3r_nj100_power_plot <- gen.power.results.plot(params.file.base, design)
print(blocked_c2_3r_nj100_power_plot)
```

```{r nj75}
user.params.list[['nbar']] <- 75
```

$\bar{n}$ = `r user.params.list[['nbar']]`

```{r 3f.nj75}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_nj75_power_plot)
```

```{r 3r.nj75}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_nj75_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_nj75_power_plot)
```

```{r nj50}
user.params.list[['nbar']] <- 50
```

$\bar{n}$ = `r user.params.list[['nbar']]`

```{r 3f.nj50}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_nj50_power_plot)
```

```{r 3r.nj50}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_nj50_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_nj50_power_plot)
```

## Varying R2

```{r r2.10.6}
user.params.list[['R2.1']] <- rep(0.6, M)  
```

$R^2_1 =$ `r user.params.list[['R2.1']]`

```{r 3f.r2.10.6}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.1_power_plot)
```

```{r 3r.r2.10.6}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_r2.1_power_plot)
```

```{r r2.1.reset}
user.params.list[['R2.1']] <- params.default[['R2.1']]  
```

```{r r2.20.6}
user.params.list[['R2.2']] <- rep(0.6, M)  
```

$R^2_2 =$ `r user.params.list[['R2.2']]`

```{r 3f.r2.20.6}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_r2.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.2_power_plot)
```

```{r 3r.r2.20.6}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_r2.1_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_r2.1_power_plot)
```

```{r r2.2.reset}
user.params.list[['R2.2']] <- params.default[['R2.2']]  
```

```{r r2.30.6}
user.params.list[['R2.3']] <- rep(0.6, M)  
```

$R^2_3 =$ `r user.params.list[['R2.3']]`

```{r 3r.r2.30.6}
design <- "blocked_c2_3r"
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_r2.3_power_plot)
```

```{r r2.3.reset}
user.params.list[['R2.3']] <- params.default[['R2.3']] 
```


```{r r2.10r2.20r2.30}
user.params.list[['R2.1']] <- rep(0, M)  
user.params.list[['R2.2']] <- rep(0, M)  
user.params.list[['R2.3']] <- rep(0, M)  
```

$R^2_1 =$ `r user.params.list[['R2.1']]`
$R^2_2 =$ `r user.params.list[['R2.2']]`
$R^2_3 =$ `r user.params.list[['R2.3']]`

```{r 3f.r2.10r2.20r2.30}
design <- "blocked_c2_3f"
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_r2.3_power_plot)
```

```{r 3r.r2.10r2.20r2.30}
design <- "blocked_c2_3r"
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_r2.3_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_r2.3_power_plot)
```

```{r r2.reset}
user.params.list[['R2.1']] <- params.default[['R2.1']] 
user.params.list[['R2.2']] <- params.default[['R2.2']] 
user.params.list[['R2.3']] <- params.default[['R2.3']] 
```

## Varying rho

```{r rho0.2tPMnj50}
rho.default <- 0.2
user.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.default']] <- rho.default
user.params.list[['rho.V']] <- user.params.list[['rho.X']] <- user.params.list[['rho.C']] <- default.rho.matrix
user.params.list[['rho.u0']] <- user.params.list[['rho.u1']] <- default.rho.matrix
user.params.list[['rho.w0']] <- user.params.list[['rho.w1']] <- default.rho.matrix
user.params.list[['rho.r']] <- default.rho.matrix
```

$\rho =$ `r user.params.list[['rho.default']]`

```{r 3f.rho0.2}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_rho0.2_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_rho0.2_power_plot)
```

```{r rho0.8}
rho.default <- 0.8
user.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.V']] <- user.params.list[['rho.X']] <- user.params.list[['rho.C']] <- default.rho.matrix
user.params.list[['rho.u0']] <- user.params.list[['rho.u1']] <- default.rho.matrix
user.params.list[['rho.w0']] <- user.params.list[['rho.w1']] <- default.rho.matrix
user.params.list[['rho.r']] <- default.rho.matrix
```

$\rho =$ `r user.params.list[['rho.default']]`

```{r 3f.rho0.8}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_rho0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_rho0.8_power_plot)
```

```{r rho.reset}
# reset
rho.default <- params.default[['rho.default']]
user.params.list[['rho.default']] <- rho.default
default.rho.matrix <- gen_corr_matrix(M = M, rho.scalar = rho.default)
user.params.list[['rho.V']] <- user.params.list[['rho.X']] <- user.params.list[['rho.C']] <- default.rho.matrix
user.params.list[['rho.u0']] <- user.params.list[['rho.u1']] <- default.rho.matrix
user.params.list[['rho.w0']] <- user.params.list[['rho.w1']] <- default.rho.matrix
user.params.list[['rho.r']] <- default.rho.matrix
```


## Varying true positives

```{r MDES0.12500}
user.params.list[['ATE_ES']] <- c(0.125, 0, 0)
```

ATE (ES) = `r user.params.list[['ATE_ES']]`

```{r 3f.MDES0.12500}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_mdes0.1250.00.0.00_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_mdes0.1250.00.0.00_power_plot)
```

```{r MDES.reset}
user.params.list[['ATE_ES']] <- params.default[['ATE_ES']]
```

## Varying ICC

```{r ICC20.7}
user.params.list[['ICC.2']] <- rep(0.7, M)
```

$\text{ICC}_2$ = `r user.params.list[['ICC.2']]`

```{r 3f.ICC20.7}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_c2_3f_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3f_ICC2.0.7_power_plot)
```

```{r 3r.ICC20.7}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_c2_3r_ICC2.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_ICC2.0.7_power_plot)
```

```{r ICC2.reset}
user.params.list[['ICC.2']] <- params.default[['ICC.2']]
```

```{r ICC30.7}
user.params.list[['ICC.3']] <- rep(0.7, M)
```

$\text{ICC}_3$ = `r user.params.list[['ICC.3']]`

```{r 3r.ICC30.7}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
blocked_c2_3r_ICC3.0.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_c2_3r_ICC3.0.7_power_plot)
```

```{r ICC3.reset}
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
```

## Varying Omega

```{r omega30.8}
user.params.list[['omega.3']] <- 0.8
user.params.list[['K']] <- 20
```

$\omega_3$ = `r user.params.list[['omega.3']]`

```{r 3f.omega30.8}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_i1_3f_omega3.0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3f_omega3.0.8_power_plot)
```

```{r 3r.omega30.8}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_i1_3r_omega3.0.8_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0.8_power_plot)
```

```{r omega30.8ICC30.7}
user.params.list[['omega.3']] <- 0.8
user.params.list[['ICC.3']] <- rep(0.7, M)
user.params.list[['K']] <- 20
```

$\omega_3$ = `r user.params.list[['omega.3']]`
$\text{ICC}_3$ = `r user.params.list[['ICC.3']]`

```{r 3f.omega30.8ICC30.7}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
blocked_i1_3f_omega3.0.8ICC30.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3f_omega3.0.8ICC30.7_power_plot)
```

```{r 3r.omega30.8ICC30.7}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
blocked_i1_3r_omega3.0.8ICC30.7_power_plot <- gen.power.results.plot(gen_params_file_base(user.params.list, sim.params.list, design), design)
print(blocked_i1_3r_omega3.0.8ICC30.7_power_plot)
```

```{r omega3.ICC3.reset}
user.params.list[['omega.3']] <- params.default[['omega.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
```


# MDES validation

```{r}
# reset to defaults
user.params.list <- params.default 
```


```{r 3f.mdes.D1}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes_D1indiv')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3f_mdes_D1_results <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_c2_3f_mdes_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3f.mdes.min2}
mdes.file <- find_file(params.file.base, type = 'mdes_min2')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3f_mdes_min2_results <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_i1_2c_mdes_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3r.mdes.D1}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
mdes.file <- find_file(params.file.base, type = 'mdes_D1indiv')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3r_mdes_D1_results <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_c2_3r_mdes_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3r.mdes.min2}
mdes.file <- find_file(params.file.base, type = 'mdes_min2')
if(length(mdes.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3r_mdes_min2_results <- readRDS(mdes.file)
  pander::pandoc.table(
    blocked_i1_2c_mdes_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```



# Sample size validation

```{r 3f.sample.D1}
design <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3f_sample_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_c2_3f_sample_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3f.sample.min2}
sample.file <- find_file(params.file.base, type = 'sample_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3f_sample_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_i1_2c_sample_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3r.sample.D1}
design <- "blocked_c2_3r"
user.params.list[['R2.3']] <- params.default[['R2.3']]
user.params.list[['ICC.3']] <- params.default[['ICC.3']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, design)
sample.file <- find_file(params.file.base, type = 'sample_D1indiv')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3r_sample_D1_results <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_c2_3r_sample_D1_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```

```{r 3r.sample.min2}
sample.file <- find_file(params.file.base, type = 'sample_min2')
if(length(sample.file) == 0)
{
  warning(paste('Results not yet computed for given parameters:', params.file.base))
} else
{
  blocked_c2_3r_sample_min2_results <- readRDS(sample.file)
  pander::pandoc.table(
    blocked_i1_2c_sample_min2_results,
    style = "grid", split.tables = 100, row.names = FALSE, 
    caption = design
  )
}
```