---
title: "Verification for 2-Level Blocked RCT with Constant Effects"
author: "Deni Chen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document:
    toc: true
    toc_float: true
    number_sections: true
    #theme: cerulean
---

# Loading data files

```{r}
library(yaml)

#read in configs file
configs <- yaml.load_file("configs.yaml")

#set directory for reading in files
fdir <- configs$fdir

#files
power.cor <- "Blocked_i1_2cM6n.j50J20MDES0.125_powerLIST.Rda"
simpwr.cor <- "Blocked_i1_2cM6n.j100J20ICC0MDES0.125_S3B300_R2.10_R2.20_simpwrLIST.Rda"

#load lists
load(paste0(fdir, power.cor))
load(paste0(fdir, simpwr.cor))

```


# Verify power calculations and capture run times

## Maybe different chunk for each design specification (e.g, constant, fixed, random effects)

### The simulations will take a long time so may want to run these separately, and pull results into this markdown??

```{r chunk3_verifyPower}
# loop through combinations (don't need all crossed - TBD)

# Compare power estimates from our methods vs MC methods

  # display power calculation matrices
    power_mutl_storage[[1]]["filename"]
    power_mutl_storage[[1]]["obj"]
    
    power_mutl_storage[[2]]["filename"]
    power_mutl_storage[[2]]["obj"]

  # display simulation matrices
    sim_power_storage[[1]]["simname"]
    sim_power_storage[[1]]["obj"]
  
    sim_power_storage[[2]]["simname"]
    sim_power_storage[[2]]["obj"]
    

power.rho0<- power_mutl_storage[[1]]["obj"]
sim.rho0<-sim_power_storage[[1]]["obj"]

power.rho0
sim.rho0[[1]]


#add a correlation column to the data files
corr <- c(0, .2,.5,.8)

#power_mult_storage
if(length( power_mutl_storage) == length(corr)){
  
  idx <- 1
  
  while(idx <= length(corr)){
    
    power_mutl_storage[[idx]]$obj <-  cbind(power_mutl_storage[[idx]]$obj, correlation = rep(corr[idx], nrow( power_mutl_storage[[idx]]$obj)))
    power_mutl_storage[[idx]]$obj <-  cbind(power_mutl_storage[[idx]]$obj, adjname = c("rawp", "BF","HO", "BH", "WY-SS", "WY-SD"))
    
    idx <- idx+1
  }
} else {
  print("Error length of power mult storage different than correlation parameter")
}


#sim_power_storage
if(length( sim_power_storage) == length(corr)){
  
  idx <- 1
  
  while(idx <= length(corr)){
    
    sim_power_storage[[idx]]$obj <-  cbind(sim_power_storage[[idx]]$obj, correlation = rep(corr[idx], nrow( sim_power_storage[[idx]]$obj)))
    sim_power_storage[[idx]]$obj <-  cbind(sim_power_storage[[idx]]$obj, adjname = c("rawp", "BF", "BH", "HO", "WY-SD"))
    
    idx <- idx+1
  }
} else {
  print("Error length of sim_power_storage different than correlation parameter")
}

ourmethods <- rbind(power_mutl_storage[[1]]$obj, power_mutl_storage[[2]]$obj, power_mutl_storage[[3]]$obj, power_mutl_storage[[4]]$obj)
MCmethods <- as.data.frame(rbind(sim_power_storage[[1]]$obj, sim_power_storage[[2]]$obj, sim_power_storage[[3]]$obj, sim_power_storage[[4]]$obj))




#power.rho0t<-matrix(unlist(power.rho0), ncol=13)


#sim.rho0$[df$datay == 5] <- NA


    
    
  
  # for M=1, look up in Power-Up

  # create table of results and check for if within TBD margin of error

  # create table of run times

```

# Verify MDES calculations and capture run times

```{r chunk4_verifyMDES}

# Specify power estimates that match those obtained in chunk3_verifyPower (grab from final table/matrix) and corresponding sample size - and check that returned MDES is correct

#generate MDES - code has lots of warnings/errors - unfinished?
#MDES.blockedRCT.2(M=M, numFalse = M, J=50, n.j=20, power=0.80, power.definition = "min2", MTP = "BF", marginError = 0.005,
#                          p=0.5, alpha=0.05, numCovar.1=0, numCovar.2=0, R2.1=0, R2.2=0, ICC=0, 
#                          mod.type="constant", sigma=sigma, omega=NULL,
#                          tnum = 10000, snum=2, ncl=24)


```

# Verify sample size calculations and capture run times

```{r chunk4_verifySampleSize}

# Specify power estimates that match those obtained in chunk3_verifyPower (grab from final table/matrix) and corresponding MDES - and check that returned sample size is correct

# repeat for number of blocks, number within blocks, etc. 

```

# ?? Verify error messages


```{r chunk4_verifyErrorsWarnings}

# Pass in anticipated mistakes and show return of error messages/warnings?

```



