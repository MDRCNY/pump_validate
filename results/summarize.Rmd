---
title: "Summary of validation results"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: pdf_document
---


```{r knit.options, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE, warning = FALSE, message = FALSE, echo = FALSE,
  fig.height = 7
)
```

```{r setup}
library(here)
library(kableExtra)
library(magrittr) 
library(PUMP)
library(pander)
library(tibble)
library(tidyr)
# default tables to round to 3 digits
panderOptions('round', 3)
source(here::here("code", "misc.R"))
```

```{r}

# extract and summarize results for a particular d_m
get.d_m.results <- function(d_m, power.files)
{
  results.files <- grep(d_m, power.files, value = TRUE)
  # remove WY files
  all.files <- grep('__B', power.files, value = TRUE)
  
  # stack results
  d_m.results <- NULL
  for(file in results.files)
  {
    results <- readRDS(here::here('output', file))

    results.wide <- results %>%
      pivot_wider(names_from = c(method, value.type), values_from = value)
    
    d_m.results <- rbind(d_m.results, results.wide)
  }

  row.names(d_m.results) <- NULL
  d_m.results %<>% mutate(
    cover =
      Sim_ci_lower < PUMP_adjusted_power &
      Sim_ci_upper > PUMP_adjusted_power,
    bias.sim = abs(Sim_adjusted_power - PUMP_adjusted_power) / PUMP_adjusted_power,
    bias.pow = abs(PowerUp_adjusted_power - PUMP_adjusted_power) / PUMP_adjusted_power
  )
  d_m.results$d_m <- d_m

  return(d_m.results)
}
```


```{r}
# find files
all.files <- list.files(here::here('output'))
# restrict to relevant files
power.files <- grep('power', all.files, value = TRUE)
# power.files <- grep('5000_S', power.files, value = TRUE)
power.files <- grep('5000_S', power.files, value = TRUE)

# d_m.list <- c(
#   "d1.1_m1c", "d2.1_m2fc", "d2.1_m2ff", "d2.1_m2fr",
#   "d2.2_m2rc", "d3.1_m3rr2rr", "d3.2_m3ff2rc", "d3.2_m3rr2rc", "d3.3_m3rc2rc"
# )
d_m.list <- c(
  "d2.1_m2fc", "d2.1_m2ff", "d2.1_m2fr",
  "d2.2_m2rc", "d3.1_m3rr2rr", "d3.2_m3ff2rc", "d3.2_m3rr2rc", "d3.3_m3rc2rc"
)

all.results <- NULL
for(d_m in d_m.list)
{
  d_m.results <- get.d_m.results(d_m, power.files)
  all.results <- rbind(all.results, d_m.results)
}
```

```{r}
# summarize
summary.results <- ddply(
  all.results, c('d_m', 'MTP', 'power_type'), summarise,
  cover = mean(cover),
  mean.bias.sim = mean(bias.sim),
  mean.bias.pow = mean(bias.pow)
)

# extract out problem rows
problems <- all.results[!is.na(all.results$cover) & all.results$cover != 1,]
problems <- problems %>%
  dplyr::select(
    MTP, power_type, PUMP_adjusted_power,
    PowerUp_adjusted_power, Sim_adjusted_power,
    Sim_ci_upper, Sim_ci_lower
  )

print(problems)
```

```{r}
# summarize
summary.results <- ddply(
  all.results, c('d_m', 'MTP', 'power_type'), summarise,
  cover = mean(cover),
  mean.bias.sim = mean(bias.sim),
  mean.bias.pow = mean(bias.pow)
)
```


```{r, results = 'asis'}
for(scenario in d_m.list)
{
  table.data <- dplyr::filter(summary.results, d_m == scenario)
  
  print(kable(table.data, booktabs = TRUE, row.names = FALSE))
}
```



