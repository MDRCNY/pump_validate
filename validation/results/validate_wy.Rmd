---
title: "Validate Power: Westfall-Young"
author: "Kristin Porter, Zarni Htet, Kristen Hunter"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    highlight: monochrome
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
  github_document:
    df_print: paged
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    toc: yes
---

```{r knit.options, echo = FALSE}
# by default, all code chunks will cache their results
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, echo = FALSE)
```

```{r setup}
library(here)
library(pander)    # For good table format

# default tables to round to 3 digits
panderOptions('round', 3)

# simulation and user parameters
source(here::here("Validation/Simulations", "params.R"))

sim.params.list[['procs']] <- c("Bonferroni", "BH", "Holm", "WY-SS")

# defaults
sim.params.list[['S']] <- 500
sim.params.list[['Q']] <- 1
sim.params.list[['B']] <- 3000

user.params.list[['ATE_ES']] <- rep(0.125, M)
user.params.list[['nbar']] <- 50
user.params.list[['J']] <- 20
user.params.list[['K']] <- 10

user.params.default <- user.params.list
sim.params.default <- sim.params.list
```

# Blocked 2 level models

```{r blocked.2}
user.params.list <- user.params.default
sim.params.list <- sim.params.default
user.params.list[['nbar']] <- 50
user.params.list[['K']] <- 1
user.params.list[['ICC.3']] <- NULL
user.params.list[['omega.3']] <- NULL
user.params.list[['R2.3']] <- NULL
user.params.list[['nbar']] <- 50

# to get good WY results
user.params.list[['J']] <- 60

# so power isn't too high
user.params.list[['ATE_ES']] <- rep(0.1, M)
```

Constant effects

```{r blocked.2c}
d_m <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
user.params.list[['ICC.2']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2c_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2c_power_plot)
```

Fixed effects

```{r blocked.2f}
d_m <- "blocked_i1_2f"
user.params.list[['omega.2']] <- user.params.default[['omega.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2f_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2f_power_plot)
```

Random effects

```{r blocked.2r}
d_m <- "blocked_i1_2r"
user.params.list[['ICC.2']] <- user.params.default[['ICC.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

## No discrepancy

Large $B = 10000$ and large $J = 100$

```{r largeB}
sim.params.list[['B']] <- 10000
user.params.list[['J']] <- 100
```

Constant effects

```{r blocked.2c.largeB}
d_m <- "blocked_i1_2c"
user.params.list[['omega.2']] <- 0
user.params.list[['ICC.2']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2c_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2c_power_plot)
```

Fixed effects

```{r blocked.2f.largeB}
d_m <- "blocked_i1_2f"
user.params.list[['omega.2']] <- user.params.default[['omega.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2f_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2f_power_plot)
```

Random effects

```{r blocked.2r.largeB}
d_m <- "blocked_i1_2r"
user.params.list[['ICC.2']] <- user.params.default[['ICC.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

Random effects with large $B = 10000$ and large $J = 100$ with lower power

```{r blocked.2r.largeB.lowpower}
d_m <- "blocked_i1_2r"
user.params.list[['nbar']] <- 100
user.params.list[['ATE_ES']] <- rep(0.05, M)

user.params.list[['ICC.2']] <- user.params.default[['ICC.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

## Different combinations of $B$ and $J$

Random effects with small $J = 15$ and medium $B = 3000$

```{r blocked.2r.smallJ}
d_m <- "blocked_i1_2r"
user.params.list[['J']] <- 15
sim.params.list[['B']] <- 3000
user.params.list[['ATE_ES']] <- rep(0.1, M)
user.params.list[['nbar']] <- 50
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

Random effects with small $B = 200$ and large $J = 60$

```{r blocked.2r.smallB}
d_m <- "blocked_i1_2r"
user.params.list[['J']] <- 60
sim.params.list[['B']] <- 200
user.params.list[['ATE_ES']] <- rep(0.1, M)
user.params.list[['nbar']] <- 50
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```


Random effects with large $B = 10000$ and small $J = 20$

```{r blocked.2r.largeB.smallJ}
d_m <- "blocked_i1_2r"
sim.params.list[['B']] <- 10000
user.params.list[['J']] <- 20
user.params.list[['nbar']] <- 50
user.params.list[['ATE_ES']] <- rep(0.125, M)
user.params.list[['ICC.2']] <- user.params.default[['ICC.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

Random effects with large $B = 10000$ and medium $J = 30$

```{r blocked.2r.largeB.medJ}
d_m <- "blocked_i1_2r"
sim.params.list[['B']] <- 10000
user.params.list[['J']] <- 30
user.params.list[['nbar']] <- 50
user.params.list[['ATE_ES']] <- rep(0.125, M)
user.params.list[['ICC.2']] <- user.params.default[['ICC.2']]
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_2r_power_plot)
```

# Cluster 2 level

```{r cluster.2c}
user.params.list <- user.params.default
sim.params.list <- sim.params.default
user.params.list[['nbar']] <- 50

user.params.list[['K']] <- 1
user.params.list[['ICC.3']] <- NULL
user.params.list[['omega.3']] <- NULL
user.params.list[['R2.3']] <- NULL
user.params.list[['omega.2']] <- 0

# params to help have a decent power
user.params.list[['ICC.2']] <- rep(0.1, M)
user.params.list[['J']] <- 60
user.params.list[['ATE_ES']] <- rep(0.25, M)

d_m <- "simple_c2_2r"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
simple_c2_2r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(simple_c2_2r_power_plot)
```

# Blocked 3 level

```{r blocked.3r}
user.params.list <- user.params.default
sim.params.list <- sim.params.default

# for a reasonable runtime
user.params.list[['J']] <- 20
user.params.list[['K']] <- 20
user.params.list[['nbar']] <- 20
    
d_m <- "blocked_i1_3r"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_i1_3r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_i1_3r_power_plot)
```

# Cluster 3 level

```{r cluster.3r}
user.params.list <- user.params.default
sim.params.list <- sim.params.default
user.params.list[['nbar']] <- 50

# assumptions
user.params.list[['omega.2']] <- 0
user.params.list[['omega.3']] <- 0

# for a reasonable runtime and power
user.params.list[['J']] <- 40
user.params.list[['K']] <- 20
user.params.list[['ATE_ES']] <- rep(0.25, M)
user.params.list[['ICC.3']] <- rep(0.1, M)
user.params.list[['ICC.2']] <- rep(0.1, M)

d_m <- "simple_c3_3r"
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
simple_c3_3r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(simple_c3_3r_power_plot)
```

# Blocked cluster

```{r blocked.cluster}
user.params.list <- user.params.default
user.params.list[['omega.2']] <- 0
```

Blocked cluster, fixed effects

```{r blocked.cluster.3f}
d_m <- "blocked_c2_3f"
user.params.list[['R2.3']] <- rep(0, M)
user.params.list[['ICC.3']] <- rep(0, M)
params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_c2_3f_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_c2_3f_power_plot)
```

Blocked cluster, random effects

```{r blocked.cluster.3r}
d_m <- "blocked_c2_3r"
user.params.list[['R2.3']] <- user.params.default[['R2.3']]
user.params.list[['ICC.3']] <- user.params.default[['ICC.3']]

# for a reasonable runtime and power
user.params.list[['J']] <- 15
user.params.list[['K']] <- 15
user.params.list[['nbar']] <- 30
user.params.list[['ATE_ES']] <- rep(0.25, M)
# user.params.list[['ICC.3']] <- rep(0.1, M)
# user.params.list[['ICC.2']] <- rep(0.1, M)

params.file.base <- gen_params_file_base(user.params.list, sim.params.list, d_m)
blocked_c2_3r_power_plot <- gen.power.results.plot(params.file.base, d_m)
print(blocked_c2_3r_power_plot)
```

